<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>dev.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">65.52</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">962</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">80.69</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">10.62</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var kidzouModule = (function() { //havre de paix

	//bouton de partage facebook
	function fbs_click() {u=location.href;t=document.title;window.open(&#039;http://www.facebook.com/sharer.php?u=&#039;+encodeURIComponent(u)+&#039;&amp;t=&#039;+encodeURIComponent(t),&#039;sharer&#039;,&#039;toolbar=0,status=0,width=626,height=436&#039;);return false;}

	//extensions du modèle objet de String
	String.prototype.addSlashes = function(str)
	{return this.replace(/[\\&quot;&#039;]/g, &#039;\\$&amp;&#039;).replace(/\u0000/g, &#039;\\0&#039;);};
	 
	String.prototype.stripSlashes = function(str)
	{return this.replace(/\\(.?)/g, function (s, n1){switch (n1){case &#039;\\&#039;:return &#039;\\&#039;;case &#039;0&#039;:return &#039;\u0000&#039;;case &#039;&#039;:return &#039;&#039;;default:return n1;}});};

	String.prototype.toBoolean = function()
	{switch(this.toLowerCase()){case &quot;true&quot;: case &quot;yes&quot;: case &quot;1&quot;: return true;case &quot;false&quot;: case &quot;no&quot;: case &quot;0&quot;: case null: return false;default: return Boolean(this);}};

	var logger = function() {

		var logLevel 		= false;

		function setLogging(bool) {logLevel = bool.toBoolean();}
		function debug(msg) {if (logLevel) console.debug(msg);}
		function info(msg) {if (logLevel) console.log(msg);}

		return {
			setLogging : setLogging,
			debug : debug,
			info : info
		};
	}();


	var kidzou = function() {
		// console.log(kidzouMessage);
		var message			= new kidzouMessage.message();
		var votesModel 		= new VotesModel(); 
		var eventsModel 	= new EventsModel();
		var activateSync 	= false;

		var initInteractions = function () {

			logger.debug(&quot;initInteractions&quot;);

			//fill the votables, ready to be updated and voted
		    ko.utils.arrayMap(jQuery(&#039;.votable&#039;), function(item) {
				votesModel.votableIds.push( jQuery(item).data(&#039;post&#039;) );
			    votesModel.votableItems.push(new VotableItem ( jQuery(item).data(&#039;post&#039;), 0, false) );
			});

			ko.utils.arrayMap(jQuery(&#039;.selectableEvent&#039;), function(item) {
				var event 				= new EventItem ();
				event.id 				= jQuery(item).data(&#039;event&#039;);
				event.connections_id 	= parseInt(jQuery(item).data(&#039;connections&#039;));
				event.event_timestamp ( parseInt(jQuery(item).data(&#039;timestamp&#039;)) );
				event.connections_timestamp	( parseInt(jQuery(item).data(&#039;connectionstimestamp&#039;)) );
			    eventsModel.events[event.id] 	= event;
			});

		}(); //auto-executée

		function selectEventById(id) {
			logger.debug(&quot;selectEventById &quot; + id);
			ko.utils.arrayFirst(eventsModel.events, function(item) {
		        if ( typeof item !== &quot;undefined&quot; &amp;&amp; item!==null &amp;&amp; item.id ==  id) {
		        	eventsModel.selectEvent(item);
		        	return true;
		        }
		    });
		}

		function mapVotedToVotables(_voted) {
			logger.debug(&quot;mapVotedToVotables &quot; + ko.toJSON(_voted));
			// debug(&quot;votesModel.votableItems &quot; + ko.toJSON(votesModel.votableItems));
			ko.utils.arrayForEach(_voted, function(item) {
				ko.utils.arrayFirst(votesModel.votableItems, function(i) {
		            if ( i.id == item.id) i.voted(true);    
		        });
			});
		}

		/**
		* rafraichissement du nombre votes pour les éléments votables 
		* 
		*/
		function refreshVotesCount() {
			jQuery.getJSON(kidzou_commons_jsvars.api_get_votes_status, {
					posts_in: ko.toJSON(votesModel.votableIds)
				},
				function(data) {
					setVotesCount(data.status);
		        }
		    );
		}

		function setVotesCount(votes) {
			ko.utils.arrayMap(votes, function(item) {
				var matchedItem = ko.utils.arrayFirst(votesModel.votableItems, function(i) {
		            if (i.id == item.id) return i;
		        });
		        if (matchedItem!==null)
		        	matchedItem.votes( item.votes );
			});
		}

		/**
		* si le localStorage n&#039;est pas supporté, les votes ne sont pas stockés en local
		* dans ce cas on rafraichit systématiquement les données en provenance du serveur
		*
		* Lié avec la fonction d&#039;écriture des votes lorsque le user recommande/ne recommande pas un article
		* @see VotableItem.prototype
		*/
		function refreshUserVotes() {

	        var localVotes 			 = JSON.parse(storageSupport.getLocal(&quot;voted&quot;));
	        var user_hash 			 = getUserHash();

	        if (localVotes===null || localVotes.length===0) 
			{
				logger.debug(&quot;localVotes null pour user_hash &quot; + user_hash);

				//assurer de ne pas passer la valeur &quot;null&quot; dans la requete
				//renvoyer dans ce cas une chaine vide
				//cela peut arriver à cause du legacy ou lorsque le user est identifié
				if (user_hash===null || user_hash===&quot;undefined&quot; ) {
					user_hash=&quot;&quot;;
				}

				jQuery.getJSON(kidzou_commons_jsvars.api_get_votes_user, { user_hash: getUserHash() })
				.done(function(d) {
					
					logger.debug(&quot;storeLocalVotes &quot; + ko.toJSON(d));
					
					//cas des users loggués : le user_hash n&#039;est pas renvoyé
					if (d!==null &amp;&amp; d.user_hash!==null &amp;&amp; d.user_hash!==&quot;undefined&quot;)
						setUserHash(d.user_hash); //pour réutilisation ultérieure
					
					if (d!==null &amp;&amp; d.voted!==null &amp;&amp; d.voted.length &gt; 0) {
						storageSupport.toLocalData(&quot;voted&quot;, d.voted);
						mapVotedToVotables(d.voted);
					}
		        });
			}
			else
				mapVotedToVotables(localVotes);
			
		} 

		/**
		* permet d&#039;identifier un user anonyme
		* le hash est fourni par le serveur, voir hash_anonymous() dans kidzou_utils
		**/
		function setUserHash (hash) {

			if (hash===null || hash===&quot;&quot; || hash===&quot;undefined&quot;) //prevention des cas ou le user est identifié : son user_hash est null
				return;

			if (getUserHash()===null || getUserHash()===&quot;&quot; || getUserHash()===&quot;undefined&quot;) {
				logger.debug(&quot;setUserHash : &quot; + hash);
				storageSupport.setLocal(&quot;user_hash&quot;, hash);
			}
		}

		/**
		* permet d&#039;identifier un user anonyme
		* le hash est fourni par le serveur, voir hash_anonymous() dans kidzou_utils
		**/
		function getUserHash ( ) {

			if (storageSupport.getLocal(&quot;user_hash&quot;)===&quot;undefined&quot;) { //pour le legacy
				logger.debug(&quot;user_hash undefined&quot; );
				storageSupport.removeLocal(&quot;user_hash&quot;);
			}

			return storageSupport.getLocal(&quot;user_hash&quot;);
		}


		
		function syncData(bool) 
		{
			activateSync = bool.toBoolean();

			storageSupport.setLocalSupport(activateSync);
			storageSupport.removeLocalData(&quot;kidzou_voted_posts&quot;); //legacy, remplacé par &quot;voted&quot;

			logger.debug(&#039;syncData &#039; + bool);
			
			if(typeof(Worker)!==&quot;undefined&quot; &amp;&amp; activateSync)
			{
				logger.info(&quot;*** syncEvents Worker Started ***&quot;);

			  	syncEvents();

			  	if (kidzou_commons_jsvars.cfg_activate_syncvotes) 
			  		syncVotes(); //rafraichissement en background par un worker
			  	else  
			  		refreshVotes(); //rafraichissement executé dans ce JS
			}
			else 
				refreshVotes();
		}

		function refreshVotes() {

			logger.info(&quot;*** refreshVotes votes (no worker) ***&quot;);

			refreshVotesCount();  //cached by server

			refreshUserVotes(); //cached with local storage if supported or cookie if not
		}

		/**
		* pour les navigateurs qui le supportent
		* ce job va synchroniser les votes du user cachés en local (comparaison des votes locaux par rapport aux votes stockés sur le serveur)
		* - parcours des votes locaux
		* 	- si les votes locaux n&#039;existent pas, récupération des votes sur le serveur et stockage en local
		* 	- si les votes locaux existent, on ne fait rien 
		*
		*/
		function syncVotes ( ) 
		{
			var worker = new Worker(kidzou_commons_jsvars.js_syncVotes_url);
			
			worker.addEventListener(&quot;message&quot;, function (event) {

				switch (event.data.cmd) {

					case &#039;setVotesCount&#039;:
						
						logger.debug(&quot;setVotesCount &quot; + ko.toJSON(event.data.response.status));
						setVotesCount(event.data.response.status);
						
						break;	
					
					case &#039;storeLocalVotes&#039;:
						
						logger.debug(&quot;storeLocalVotes &quot; + ko.toJSON(event.data.response.voted));

						//cas des users loggués : le user_hash n&#039;est pas renvoyé
						if (event.data.response.user_hash!==null &amp;&amp; event.data.response.user_hash!==&quot;undefined&quot;)
							setUserHash(event.data.response.user_hash); //pour réutilisation ultérieure
						
						storageSupport.toLocalData(&quot;voted&quot;, event.data.response.voted);
						mapVotedToVotables(event.data.response.voted);
						
						break;	

					case &#039;mapLocalVotes&#039;:
						
						logger.debug(&quot;localVotes existants utilisés : &quot; + ko.toJSON(event.data.response));
						mapVotedToVotables(event.data.response);
						
						break;	

					case &#039;debug&#039;:
						logger.debug(event.data.message);
						break;

					default:
						logger.debug(event.data);
				}
	        }, false);

	        //rafraichissement des votes totaux 
	        worker.postMessage({ 
	        	cmd 	  	  		 : &quot;refreshVotesCount&quot;,
	        	API_VOTES_STATUS_URL : kidzou_commons_jsvars.api_get_votes_status,
	        	votesData 			 : {
	        		posts_in 			 : ko.toJSON(votesModel.votableIds)
	        	}
	        });
	        
	        //rafraichissement des votes du user
	        worker.postMessage({ 
	        	cmd 	  	  		 : &quot;syncVotes&quot;,
	        	API_USERVOTES_URL    : kidzou_commons_jsvars.api_get_votes_user,
	        	votesData 			 : {
	        		localVotes 			 : storageSupport.getLocal(&quot;voted&quot;),
	        		posts_in 			 : ko.toJSON(votesModel.votableIds), 
	        		user_hash 			 : getUserHash()
	        	}
	        });
	        
	        // debug(&quot;worker terminate()&quot;);
			// worker.terminate();
		}

		/**
		* pour les navigateurs qui le supportent
		* ce job va synchroniser les events locaux avec la derniere version des events dispo sur le serveur (attention, le serveur gere également un cache)
		* - suppression des events en localStorage dont le cache a expiré
		* - suppression des events en localStorage modifiés sur le serveur (le timestamp a bougé)
		* - prefetech des events et stockage en local
		*
		* La mécanique repose sur le fait que les events en localStorage ont pour clé event-&quot;id&quot;-&quot;timestamp&quot;-&quot;connections_id&quot;-&quot;connections_timestamp&quot;
		* les attributs timestamp et connections_timestamp étant des ko.observable(), dès que leur valeur change, la clé de stockage change (storageKey())
		* (le timestamp est fourni par le serveur)
		*/
		function syncEvents() 
		{

			var worker = new Worker(kidzou_commons_jsvars.js_syncEvents_url);
			var events = eventsModel.events;
			
			worker.addEventListener(&quot;message&quot;, function (event) {

				switch (event.data.cmd) {
					
					case &#039;removeLocalEvent&#039;:
						
						var id 			= parseInt(event.data.id);
						var event_timestamp 		= parseInt(event.data.event_timestamp);
						var connections_id 			= parseInt(event.data.connections_id);
						var connections_timestamp 	= parseInt(event.data.connections_timestamp);

						var key = &quot;event-&quot; + id ;

						//reprise de l&#039;historique, certains evenements n&#039;avaient pas de timestamp dans leur clé...
						if (event_timestamp&gt;0)
							key = key + &quot;-&quot; + event_timestamp;
						if (connections_id&gt;0)
							key = key + &quot;-&quot; + connections_id;
						if (connections_timestamp&gt;0)
							key = key + &quot;-&quot; + connections_timestamp;

	        			storageSupport.removeLocalData(key);
			        		
						break;	

					case &#039;storeLocalEvents&#039;:

						for (var i=0; i&lt;event.data.data.events.length; i++)
							storageSupport.toLocalData( &quot;event-&quot; + event.data.data.events[i].id  + &quot;-&quot; + event.data.data.events[i].event_timestamp + &quot;-&quot; + event.data.data.events[i].connections_id + &quot;-&quot; + event.data.data.events[i].connections_timestamp , event.data.data.events[i]);
				
						break;	

					case &#039;debug&#039;:
						logger.debug(event.data.message);
						break;

					default:
						logger.debug(event.data);
				}
	        }, false);

			//recolte des events stockés dans le HTML (page_events)
	        var page_events = [];
	        ko.utils.arrayForEach(jQuery(&#039;.selectableEvent&#039;), function(item) {
			 	var id 				= parseInt(jQuery(item).data(&#039;event&#039;));
			 	var event_timestamp = parseInt(jQuery(item).data(&#039;timestamp&#039;));
			 	var connections_id 	= parseInt(jQuery(item).data(&#039;connections&#039;));
			 	var connections_timestamp	= parseInt(jQuery(item).data(&#039;connectionstimestamp&#039;));
			 	page_events.push({
			 		id 						: id, 
			 		event_timestamp			: event_timestamp,
			 		connections_id 			: connections_id,
			 		connections_timestamp	: connections_timestamp
			 	});
	        });

	        logger.debug(&quot;page_events &quot; + ko.toJSON(page_events));

	        //recolte des events stockés dans le localStorage
	        //
	        //nous assumons que localStorage existe si le user accepte les web workers
	        //assumons également que les clés sont du type event-123-timestamp-fiche-tmsp_de_la_fiche (ou xxxx est le timestamp de creation de la clé)
	        var local_events = [];
	        for (var i=0; i&lt;localStorage.length; i++)
	        {
	        	var key 	 = localStorage.key(i);
	        	var keyParts = key.split(&quot;-&quot;);
	        	if (keyParts[0]===&quot;event&quot;)
	    		{
	    			if (keyParts.length&lt;4) {
	    				//données incohérentes, supprimer les fiches locales qui n&#039;ont pas une clé normale
	    				storageSupport.removeLocalData(key);
	    				// console.log(&quot;suppression de la clé &quot; + key);
	    			}
	    			else {
	    				var id 				= JSON.parse(localStorage.getItem(key)).id;
	        			var event_timestamp	= JSON.parse(localStorage.getItem(key)).event_timestamp || 0;  //reprise de l&#039;historique
	        			var connections_id 	= JSON.parse(localStorage.getItem(key)).connections_id || 0;  //reprise de l&#039;historique
	        			var connections_timestamp 	= JSON.parse(localStorage.getItem(key)).connections_timestamp || 0;  //reprise de l&#039;historique 
	        			local_events.push({
	        				id 						: parseInt(id), 
	        				event_timestamp			: parseInt(event_timestamp),
	        				connections_id 			: parseInt(connections_id),
	        				connections_timestamp 	: parseInt(connections_timestamp)
	        			});
	    			}
	    			
	    		}
	    	}

	    	//logger.debug(&quot;local_events &quot; + ko.toJSON(local_events));
	        
	        //c&#039;est parti pour le job de synchro
	        worker.postMessage({ 
	        	cmd 	  	  		 : &quot;syncEvents&quot;,
	        	API_EVENTS_FETCH_URL : kidzou_commons_jsvars.api_get_event,
	        	eventsData 	  		 : {
		        		page_events  	 : ko.toJSON(page_events),
		        		local_events 	 : ko.toJSON(local_events) 
	        	}
	        });
	        
	        // debug(&quot;worker terminate()&quot;);
			// worker.terminate();
		}

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////////////////////// Modele objet exposé publiquement, utilisé par le UI ////////////////////////////////
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////

		

		function VotesModel() {

			var self 			= this;
			self.votableIds 	= []; //only for JSON request
			self.votableItems 	= [];

			self.getVotableItem = function (_id) {
				return ko.utils.arrayFirst(self.votableItems, function(item) {
		  		    if (item.id == _id) return item;
		    	});
			};

		}

		function VotableItem ( _id, _votes, _voted) {

			var self 		= this;

			self.id 		= _id;
			self.votes 		= ko.observable(_votes);
			self.voted 		= ko.observable(_voted);
			self.downActivated = ko.observable(false); 

			self.countText 	= ko.computed(function() {
				if (self.downActivated())
					return kidzou_commons_jsvars.votable_countText_down;
				else
					return kidzou_commons_jsvars.votable_countText; 
			});

			self.iconClass = ko.computed(function() {
				return self.voted() ? &#039;icon-alreadyvoted&#039; : &#039;icon-heart&#039;;
			});

			//si le user a deja voté et qu&#039;il survole le lien de recommandation
			//on met à jour le lien pour qu&#039;il devienne une action de retrait du vote
			//ce changement d&#039;action est appelé par le texte &#039;stop&#039; visible à coté du texte &#039;recommandation&#039;
			//lorsque le user a voté
			self.activateDown = function() {
				if (self.voted()) {
					self.downActivated(true);
				}
			};

			self.doUpOrDown = function() {
				//console.dir(this);
				if (self.voted()) 
					self.doWithdraw();
				else
					self.doVote();
			};

			//quoiqu&#039;il arrive, le countText est reinitialisé lorsque la souris est éloignée de l&#039;item
			self.deactivateDown = function() {
				self.downActivated(false);
			};

			self.doVote = function() {

				logger.debug(&quot;doVote&quot;);

				if (this.voted()) return;

				var _id = this.id;

				//update the UI immediatly and proceed to the vote in back-office
				var count = parseInt(this.votes())+1;
				this.voted(true);
				this.votes(count);

				logger.info(&quot;doVote &quot; + _id + &quot;(+1)&quot;);

				//get nonce for voting and proceed to vote
				jQuery.getJSON(kidzou_commons_jsvars.api_get_nonce,{controller: &#039;vote&#039;,	method: &#039;up&#039;})
					.done(function (data) {
						logger.debug(&quot;doVote &quot; + ko.toJSON(data));
						if (data!==null) {
				           var nonce =  data.nonce;
				           //vote with the nonce
				           jQuery.getJSON(kidzou_commons_jsvars.api_vote_up, {
									post_id: _id, 
									nonce: nonce,
									user_hash : getUserHash()
								}, function(data) {
									//cas des users loggués, le user_hash n&#039;est aps renvoyé
									if (data.user_hash!==null &amp;&amp; data.user_hash!==&quot;undefined&quot;)
										setUserHash(data.user_hash); //pour reuntilisation ultérieure
									
									storageSupport.removeLocalData(&quot;voted&quot;); //pour rafraichissement à la prochaine requete
									logger.debug(&quot;doVote executed&quot;);
								}
							); 
				        }
			        });
			};

			//retrait du vote (&#039;Je ne recommande plus&#039;)
			self.doWithdraw = function() {

				if (!this.voted()) return;

				var _id = this.id;

				//update the UI immediatly and proceed to the withdraw in back-office
				var count = parseInt(this.votes())-1;
				this.voted(false);
				this.votes(count);

				logger.info(&quot;doWithdraw &quot; + _id + &quot;(-1)&quot;);

				//get nonce for voting and proceed to vote
				jQuery.getJSON(kidzou_commons_jsvars.api_get_nonce,{controller: &#039;vote&#039;,	method: &#039;down&#039;})
					.done(function (data) {
			           var nonce =  data.nonce;
			           //vote with the nonce
			           jQuery.getJSON(kidzou_commons_jsvars.api_vote_down, {
								post_id: _id, 
								nonce: nonce,
								user_hash : getUserHash()
							}, function(data) {
								//cas des users loggués, le user_hash n&#039;est aps renvoyé
								if (data.user_hash!==null &amp;&amp; data.user_hash!==&quot;undefined&quot;)
									setUserHash(data.user_hash); //pour reuntilisation ultérieure
								
								storageSupport.removeLocalData(&quot;voted&quot;); //pour rafraichissement à la prochaine requete
								logger.debug(&quot;doWithdraw executed&quot;);
							}
						); 
			        });
			};
		}

		function EventsModel() {

			var self 				= this;
			self.events 			= [];
			self.selectedEvent   	= ko.observable(new EventItem()); //contient les evenements clickés par le user
			self.scriptsLoaded	 	= false; //cache les scripts chargés (google map)

			// self.isPhone = ko.computed(function() {
			// 	if (ko.isObservable(self.selectedEvent().phone_number))
		 //       		return self.selectedEvent().phone_number()!= &#039;&#039;;
		 //       	else
		 //       		return self.selectedEvent().phone_number!= &#039;&#039;;
		 //    });

			//un element est selectionné, cette fonction est appelée
			self.selectEvent = function(ev) {

				logger.info(&quot;selectEvent &quot; + ev.id);

				var start = (new Date()).getMilliseconds();

				message.addMessage(&#039;info&#039;, kidzou_commons_jsvars.msg_loading);
				
				this.selectedEvent(ev);   

				//essayer de recupérer en local
				var localEvent = storageSupport.fromLocalData( ev.storageKey() );

				//attention : si les données locales sont moins fraiches que les données serveur
				//on ne mappe pas les données locales, tant pis on va chercher les données serveur
				//ca cas peut arriver si le HTML renvoie un timestamp qui n&#039;est pas à jour
				//autrement dit : le cache HTML et/ou DB masque renvoie un timestamp inférieur à celui renvoyé
				//par un appel JSON et stocké en local lors du Job de synchro...
				//
				if ( localEvent!==null &amp;&amp; (parseInt(localEvent.event_timestamp) === parseInt(ev.event_timestamp())) &amp;&amp; (parseInt(localEvent.connections_id)  === parseInt(ev.connections_id)) &amp;&amp; (parseInt(localEvent.connections_timestamp)  === parseInt(ev.connections_timestamp())) )
				{
					// resetEventsTabs();
					mapEventData(ev, localEvent, function( ) {
							// console.log(&quot;mapEventData done&quot;);
			    			dialogs.showFancybox( jQuery(&#039;#event-details&#039;).html(), function() {
									dialogs.resetEventsTabs();
								});
						});

					var end = (new Date()).getMilliseconds();

					kidzouTracker.trackEvent(&#039;Fiche Agenda&#039;, location.pathname, ev.title(), (end - start));
				}
				else 
				{
					//forcer le rechargement des données
					//l&#039;entrée incohérente en localStorage sera supprimée par le job de synchro
					jQuery.getJSON(kidzou_commons_jsvars.api_get_event,{event_id: ev.id})
						.done(function (data) {
							mapEventData(ev, data.event[0], function( ) {
				    			dialogs.showFancybox( jQuery(&#039;#event-details&#039;).html(), function() {
										dialogs.resetEventsTabs();
									});
							});

							var end = (new Date()).getMilliseconds();
										
							kidzouTracker.trackEvent(&#039;Fiche Agenda&#039;, location.pathname, ev.title(), (end - start));

				        	//il est temps d&#039;écrire les données en local pour court-circuiter la recup JSON au prochain appel
				        	storageSupport.toLocalData( ev.storageKey() , ev);
						});
				}

			}; //selectEvent
		}

		function mapEventData(ev, data, callback) {

			if (data===null)
				return;

			var content 	= data.extra_info || data.content 		|| &quot;&quot;;
			var link 		= (typeof data.link !== &#039;undefined&#039; &amp;&amp;  typeof data.link !== &#039;string&#039; ? data.link.link: data.link);
			var link_title 	= (typeof data.link !== &#039;undefined&#039; &amp;&amp;  typeof data.link !== &#039;string&#039; ? data.link.title : data.link_title);
			var connections_adresse = (typeof data.connections_adresse !== &#039;undefined&#039; &amp;&amp;  typeof data.connections_adresse !== &#039;string&#039; ? data.connections_adresse : data);
			var formattedDates 	= data.dates_teaser || data.formattedDates || &quot;&quot;;
			var adresse 	= data.address || data.adresse || &quot;&quot;;
			var website 	= data.website || &quot;&quot;; //console.log(&quot;website &quot;+ website)
			var phone_number = data.phone_number || &quot;&quot;;

			ev.title(			data.title!==null ? data.title.stripSlashes() : &quot;&quot; );
			ev.content(			content!==null ? content.stripSlashes():&quot;&quot; );

	    	if (link!==null &amp;&amp; link!==&#039;&#039;)
	    	{
	    		ev.link(			link);
	    		ev.link_title(		typeof link_title !== &#039;undefined&#039; ? link_title.stripSlashes() : &quot;&quot; );
	    	}

	  		ev.post_title(		data.post_title!==null ? data.post_title.stripSlashes() :&quot;&quot; );
	    	ev.post_name(		data.post_name);
	    	ev.formattedDates(	formattedDates);
	    	ev.image(			data.image); 

	    	ev.website (website);
	    	ev.phone_number (phone_number);

	    	ev.venue ( data.venue!==null ? data.venue.stripSlashes(): &quot;&quot;); 
	    	ev.adresse = (adresse!==null ? adresse.stripSlashes():&quot;&quot;);
	    	
	    	ev.extra_venue = (data.extra_venue!==null &amp;&amp; typeof data.extra_venue===&#039;string&#039; ? data.extra_venue.toBoolean() : data.extra_venue); 

	    	ev.event_timestamp( parseInt(data.event_timestamp) );

	    	ev.connections_id = parseInt(data.connections_id); 
			ev.connections_timestamp( parseInt(data.connections_timestamp) );

			//on utilise l&#039;adresse de la fiche uniquement si extra_venue est à false (pas de surcharge de l&#039;adresse)
			//sinon extra_venue prévaut sur l&#039;adresse de la fiche
			if (ev.extra_venue===false &amp;&amp; parseInt(data.connections_id)&gt;0)
			{
				// console.log(ko.toJSON(data));
				if (typeof data.organization!==&quot;undefined&quot; &amp;&amp; data.organization!==&quot;&quot;)
					ev.venue(data.organization);

				ev.latitude 	= connections_adresse.latitude; 
				ev.longitude 	= connections_adresse.longitude; 

				if (adresse===null || adresse===&quot;&quot;)
					ev.adresse 	= (connections_adresse.line_1!==null ? connections_adresse.line_1.stripSlashes():&quot;&quot;) + &#039; &#039; + (connections_adresse.line_2!==null ? connections_adresse.line_2.stripSlashes():&quot;&quot;) + &#039; &#039; + (connections_adresse.line_3!==null ? connections_adresse.line_3.stripSlashes():&quot;&quot;) + &#039; &#039; + connections_adresse.zipcode + &#039; &#039; + (connections_adresse.city!==null ? connections_adresse.city.stripSlashes():&quot;&quot;);
			}

			// console.log(&quot;data &quot; + ko.toJSON(data));
			 
			//utilisation de l&#039;image de la fiche si aucune image n&#039;est renseignée
			if (ev.image()===&#039;&#039;)
				ev.image(kidzou_commons_jsvars.cfg_connections_image_base + data.connections_options.logo.name);

			callback();
		}


		//un evenemenent selectionnable
		function EventItem () {

			var self = this;

			self.id      	= 0;	//pas d&#039;interaction utilisateur
			self.selected 	= ko.observable(false); 
			self.content 	= ko.observable(&#039;&#039;); 
			self.link 		= ko.observable(&#039;&#039;); 
			self.link_title	= ko.observable(&#039;&#039;); 
			self.title 		= ko.observable(&#039;&#039;); 
			self.image 		= ko.observable(&#039;&#039;); 
			self.event_timestamp 	= ko.observable(0);

			//nouveaux champs
			self.website		= ko.observable(&#039;&#039;); 	//pas d&#039;interaction utilisateur mais mon code doit être merdique, ca ne fonctionne pâs sans observable
			self.phone_number	= ko.observable(&#039;&#039;); 	//pas d&#039;interaction utilisateur mais iden website
			
			self.connections_id 			= 0; 
			self.connections_timestamp 		= ko.observable(0);
			
			self.latitude	= 0; 	//pas d&#039;interaction utilisateur
			self.longitude	= 0; 	//pas d&#039;interaction utilisateur
			self.adresse	= &#039;&#039;;  	//pas d&#039;interaction utilisateur
			self.cached		= false;//pas d&#039;interaction utilisateur
			self.venue 		= ko.observable(&#039;&#039;);
			self.extra_venue 	= false;

			self.start_date	= &#039;&#039;;	//pas d&#039;interaction utilisateur
			self.end_date	= &#039;&#039;;	//pas d&#039;interaction utilisateur
			self.formattedDates	= ko.observable(&#039;&#039;);
			self.post_name	= ko.observable(&#039;&#039;);
			self.post_title	= ko.observable(&#039;&#039;);

			self.post_href = ko.computed(function(){
				return kidzou_commons_jsvars.cfg_site_url + self.post_name();
			});

			self.isPostAttached = ko.computed(function(){
				return self.post_name()!==&#039;&#039; &amp;&amp; self.post_name()!==null;
			});

			//un evenement est identifié par son timestamp ET le timestamp de la fiche Connections associée
			//de sorte que si l&#039;un des 2 timestamps est modifié, l&#039;event est invalidé et rechargé
			self.storageKey = ko.computed(function(){
				return &quot;event-&quot; + self.id + &quot;-&quot; + self.event_timestamp() + &quot;-&quot; + self.connections_id + &quot;-&quot; + self.connections_timestamp(); 
			});
		}

		function bindView() {
			ko.applyBindings( viewModel() ); 
			//logger.debug(&quot;bindView() executed&quot;);
			//logger.debug(&quot;viewModel.events : &quot; + ko.toJSON(viewModel().events));
		}

		function viewModel() {
			// console.log(kidzouMessage);
			return {
				message : message,
				events 	: eventsModel,
				votes 	: votesModel
			};
		}

		return { 
			viewModel 		: viewModel,
			syncData 		: syncData, 
			selectEventById : selectEventById,
			bindView 		: bindView
		};

	}();

	var dialogs = function() {

		

		function openShareDialog() 
		{
			if (jQuery(&quot;#mobile_nav&quot;).css(&quot;display&quot;)===&quot;none&quot;) {
				//console.debug(&quot;openShareDialog : #mobile_nav non affiche&quot; );
				vex.defaultOptions.contentClassName = &#039;&#039;;
				vex.defaultOptions.className 			= &#039;vex-theme-top&#039;;
				vex.defaultOptions.overlayClosesOnClick = true;
				vex.dialog.buttons.YES.text 			= &#039;Fermer&#039;;

				vex.dialog.alert({
		            message: jQuery(&#039;.newspan&#039;).html(),
		            callback: function (data) {
		            	//console.debug(&quot;callback, set newsletter à 1&quot; );
		            	storageSupport.setLocal(&#039;kz_newsletter&#039; , &#039;1&#039;);
		            }
		        });

		    //le device est trop petit pour afficher un paneau newsletter
		    //on n&#039;emebte pas le user
			} else {
				//console.debug(&quot;Smartphone en vue : set newsletter à 1 auto&quot; );
		        storageSupport.setLocal(&#039;kz_newsletter&#039; , &#039;1&#039;);
			}
			
		}

		function resetEventsTabs() {
			logger.debug(&quot;resetEventsTabs&quot;);
			jQuery(&#039;[data-content]&#039;).removeClass(&#039;active&#039;);
		  	jQuery(&#039;[data-content=&quot;info&quot;]&#039;).addClass(&#039;active&#039;);
		  	jQuery(&#039;.event-map&#039;).children().remove();
		}

		function showFancybox(content, callback) {

			resetEventsTabs();

			kidzou.viewModel().message.removeMessage();

			vex.defaultOptions.className 			= &#039;vex-theme-top&#039;;
			vex.defaultOptions.overlayClosesOnClick = true;
			vex.dialog.buttons.YES.text 			= &#039;Fermer&#039;;
			vex.defaultOptions.contentClassName 	= &#039;&#039;; //suppression de la classe &quot;login&quot; si le dialogue de login a été ouvert auparavant

			vex.dialog.alert({
				message 	: content,
				callback 	: callback()
			});

			switchEventTab();

		}

		function switchEventTab() {

			logger.debug(&quot;switchEventTab&quot;);

			///////////// EVENT TABS ///////////////
			jQuery(&quot;[data-tab]&quot;).on(&quot;click&quot;, function (e) {

				logger.debug(&quot;[data-tab]=&quot; + jQuery(this).data(&#039;tab&#039;));

			    jQuery(&#039;[data-content]&#039;).removeClass(&#039;active&#039;);
			    jQuery(&#039;[data-content=&#039; + jQuery(this).data(&#039;tab&#039;) + &#039;]&#039;).addClass(&#039;active&#039;);

			    if (jQuery(this).data(&#039;tab&#039;)===&quot;map&quot;) {
			    	if (!kidzou.viewModel().events.scriptsLoaded){
						logger.debug(&quot;Fiche Agenda - Carte =&gt; Serveur&quot;);
						kidzouTracker.trackEvent(&#039;Fiche Agenda - Carte&#039;, &#039;Serveur&#039;, &#039;Click&#039;, 0);
						jQuery.getScript(kidzou_commons_jsvars.js_google_maps + &quot;&amp;callback=kidzouModule.dialogs.initializeMap&quot;);
					}
					else{
						logger.debug(&quot;Fiche Agenda - Carte =&gt;  locale&quot;);
						kidzouTracker.trackEvent(&#039;Fiche Agenda - Carte&#039;, &#039;Locale&#039;, &#039;Click&#039;, 0);
						initializeMap(); 
					}
			    }
				
			});
		}

		//todo : le placer dans kidzou()
		function initializeMap(  ) {

			//on est sur la map, chargement des données
			jQuery(&#039;.event-map&#039;).html(&#039;&lt;span class=&quot;warning&quot;&gt;Chargement de la carte...&lt;/span&gt;&#039;);

			var options = {};
			var isLatLng = kidzou.viewModel().events.selectedEvent().latitude!==null &amp;&amp; kidzou.viewModel().events.selectedEvent().latitude!==0 &amp;&amp; kidzou.viewModel().events.selectedEvent().longitude!==null &amp;&amp; kidzou.viewModel().events.selectedEvent().longitude!==0;

			logger.debug(&quot;isLatLng &quot; + isLatLng);
			logger.debug(&quot;adresse &quot; + kidzou.viewModel().events.selectedEvent().adresse);

			if (isLatLng)
				options = {
					latitude: parseFloat(kidzou.viewModel().events.selectedEvent().latitude), 
		        	longitude: parseFloat(kidzou.viewModel().events.selectedEvent().longitude), 
			        scaleControl: true, 
					maptype: &#039;ROADMAP&#039;,
					zoom: 15
				};
			else 	{
				options = {
					address: kidzou.viewModel().events.selectedEvent().adresse, 
			        scaleControl: true, 
					maptype: &#039;ROADMAP&#039; ,
					zoom: 15
				};
			}	

			//gestion du cache : on ne recharge pas les scripts s&#039;ils ont deja ete charge 
			//lors du click sur un autre EventItem
			if (!kidzou.viewModel().events.scriptsLoaded)
			{
				logger.debug(&#039;initializeMap() =&gt; getScript&#039;);
				jQuery.getScript(kidzou_commons_jsvars.js_gomap_url, function() {
					jQuery(&quot;.event-map&quot;).goMap(options);
					kidzou.viewModel().events.scriptsLoaded = true;
					createMarker(isLatLng);
				});
			}
			else 
			{
				logger.debug(&#039;goMap &#039; + ko.toJSON(options));
				jQuery(&quot;.event-map&quot;).goMap(options);
				createMarker(isLatLng);
			}


			//fonction interne, pas de necessité de l&#039;exposer plus loin
			function createMarker(isLatLng) {

				logger.debug(&#039;createMarker &#039; + isLatLng);

				if (isLatLng)
					jQuery.goMap.createMarker({  
				            latitude: parseFloat(kidzou.viewModel().events.selectedEvent().latitude), 
							longitude: parseFloat(kidzou.viewModel().events.selectedEvent().longitude), 
							html: { 
				                content: &#039;&lt;strong&gt;&#039; + kidzou.viewModel().events.selectedEvent().venue() + &#039;&lt;/strong&gt;&lt;br/&gt;&#039; + kidzou.viewModel().events.selectedEvent().adresse, 
				                popup: true 
				            } 
				    }); 
				else {
					jQuery.goMap.createMarker({  
				            address: kidzou.viewModel().events.selectedEvent().adresse, 
				            html: { 
				                content: &#039;&lt;strong&gt;&#039; + kidzou.viewModel().events.selectedEvent().venue() + &#039;&lt;/strong&gt;&lt;br/&gt;&#039; + kidzou.viewModel().events.selectedEvent().adresse, 
				                popup: true 
				            } 
				    }); 
				}
			}

		}

		return { 
			openShareDialog 		: openShareDialog,
			// openLoginDialog 		: openLoginDialog,
			resetEventsTabs 		: resetEventsTabs,
			showFancybox 			: showFancybox,
			initializeMap 			: initializeMap
		};

	}();

	
	

	/////////////// SHARE PANEL ////////////////
	////////////////////////////////////////////

	jQuery(&quot;.share&quot;).click(function(){
		dialogs.openShareDialog();
	});


	/////////////// EVENTS ////////////////
	///////////////////////////////////////

	jQuery(&quot;.selectableEvent&quot;).on(&quot;click&quot;, function() {
		var id = jQuery(this).data(&#039;event&#039;);
		// console.debug(&quot;clické &quot; + id); 
		kidzou.selectEventById(id);
	});

	head.ready( function() {

		logger.setLogging(kidzou_commons_jsvars.cfg_debug_mode); 
		kidzou.syncData(kidzou_commons_jsvars.cfg_activate_datasync);

		kidzou.bindView();

	});

	return {
		dialogs : dialogs //necessaire de fournir un acces au dialog pour interaction avec Google Maps
	};

}());  //kidzouModule</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
