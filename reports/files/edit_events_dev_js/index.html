<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>edit-events-dev.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">68.63</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">740</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">63.09</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">8.43</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var kidzouEventsModule = (function() { //havre de paix

	var windowURL = window.URL || window.webkitURL;
	
	//voir http://jsfiddle.net/3LT9d/

	//vu sur http://www.knockmeout.net/2011/05/creating-smart-dirty-flag-in-knockoutjs.html
	//permet un autoSave du formulaire
	ko.dirtyFlag = function(root, isInitiallyDirty) {

	    var result = function() {},
	        _initialState = ko.observable(ko.toJSON(root)),
	        _isInitiallyDirty = ko.observable(isInitiallyDirty);

	    result.isDirty = ko.computed(function() { 
	        return _isInitiallyDirty() || _initialState() !== ko.toJSON(root);
	    });

	    result.reset = function() {
	        _initialState(ko.toJSON(root));
	        _isInitiallyDirty(false);
	    };

	    return result;
	};

	ko.extenders.debug = function(target, option) {
	    target.subscribe(function(newValue) {
	       console.debug(option + &quot;: &quot; + newValue);
	    });
	    return target;
	};


	//amélioration : faire un Drag &amp; Drap 
	//voir http://jsfiddle.net/3LT9d/
	ko.bindingHandlers.file = {
	    init: function(element, valueAccessor) {
	        jQuery(element).change(function() {
	            var file = this.files[0];
	            if (ko.isObservable(valueAccessor())) {
	                valueAccessor()(file);
	            }
	        });
	    },

	    update: function(element, valueAccessor, allBindingsAccessor) {
	        var file = ko.utils.unwrapObservable(valueAccessor());

	        var bindings = allBindingsAccessor();
	        // console.log(&quot;ko.isObservable(bindings.fileObjectURL)&quot; + ko.isObservable(bindings.fileObjectURL));
	        if (bindings.fileObjectURL &amp;&amp; ko.isObservable(bindings.fileObjectURL)) {
	            var oldUrl = bindings.fileObjectURL();
	            if (oldUrl) {
	                windowURL.revokeObjectURL(oldUrl);
	            }
	            bindings.fileObjectURL(file &amp;&amp; windowURL.createObjectURL(file));

	        }

	        if (bindings.fileBinaryData &amp;&amp; ko.isObservable(bindings.fileBinaryData)) {
	            if (!file) {
	                bindings.fileBinaryData(null);
	            } else {
	                var reader = new FileReader();
	                reader.onload = function(e) {
	                    bindings.fileBinaryData(e.target.result);
	                };
	                reader.readAsArrayBuffer(file);
	            }
	        }

	        if (file) {

        		//envoi sur le serveur :
		        //traitement special pour le file upload qui n&#039;est pas supporté par jQuery Ajax

		        jQuery( &quot;#serverMessage&quot; ).html(&quot;&amp;nbsp;T&amp;eacute;l&amp;eacute;chargement de la photo en cours...&quot;).fadeIn();
				
				//raz des messages d&#039;erreur
				jQuery(element).next(&quot;span&quot;).remove();

				var _file = element.files[0];

				var err = false;
				var msg = &#039;&#039;;

				if (_file.type.indexOf(&quot;image&quot;)===-1) {
					err = true;
					msg = &quot;Le fichier doit &amp;ecirc;tre une image&quot;;
				} else if (parseInt(_file.size)&gt;102400) {
					err = true;
					msg = &quot;Le taille du fichier ne doit pas exceder 100 kb&quot;;
				}

				if (!err) {
					var formData = new FormData();
					formData.append(&#039;file&#039;, _file);

					var xhr = new XMLHttpRequest();
					var response = null;
					// Add any event handlers here...
					xhr.open(&#039;POST&#039;, kidzou_jsvars.api_attach_image, true);

					xhr.onreadystatechange = function(e) {
						if (this.readyState == 4 &amp;&amp; this.status == 200) {
							response = JSON.parse(this.responseText);
							if (bindings.target &amp;&amp; ko.isObservable(bindings.target)) {
								bindings.target (response.file.url);
								jQuery( &quot;#serverMessage&quot; ).html(&quot;OK !&quot;).fadeOut(&quot;slow&quot;);
							}
						} else {
							jQuery( &quot;#serverMessage&quot; ).html(&quot;Erreur lors du t&amp;eacute;l&amp;eacute;chargement !&quot;).fadeOut(&quot;slow&quot;);
						}
					};
					xhr.send(formData);
				} else {
					jQuery(element).after(&quot;&lt;span class=&#039;form_hint&#039;&gt;&quot; + msg + &quot;&lt;/span&gt;&quot;);
				}		
	        }
	    }
	};

	ko.bindingHandlers.placecomplete = {
	    init: function(element, valueAccessor, allBindingsAccessor) {
	        var obj = valueAccessor(),
	            allBindings = allBindingsAccessor(),
	            lookupKey = allBindings.lookupKey;
	        jQuery(element).placecomplete(obj);
	        //console.log(obj);
	        if (lookupKey) {
	            var value = ko.utils.unwrapObservable(allBindings.value);
	            jQuery(element).placecomplete(&#039;data&#039;, ko.utils.arrayFirst(obj.data.results, function(item) {
	                return item[lookupKey] === value;
	            }));
	        }

	        ko.utils.domNodeDisposal.addDisposeCallback(element, function() {
	            jQuery(element).placecomplete(&#039;destroy&#039;);
	        });
	    },
	    update: function(element) {
	        jQuery(element).trigger(&#039;change&#039;);
	    }
	};

	ko.bindingHandlers.date = {
        update: function (element, valueAccessor, allBindingsAccessor, viewModel) {
            var value = valueAccessor();
            var formString = allBindingsAccessor().stringFormat;
            var dateFormat = allBindingsAccessor().dateFormat;
            var mom = moment( value, dateFormat);
            jQuery(element).text(mom.format(formString));
       }
  	};

  	ko.bindingHandlers.initCheckBox = {
	    init: function(element, valueAccessor, allBindingsAccessor, context) {
	        var value = valueAccessor();
	        if (value===&quot;1&quot;)
	        	jQuery(element).attr(&#039;checked&#039;,&#039;checked&#039;);
	        else
	        	jQuery(element).removeAttr(&#039;checked&#039;);
	        
	        //run the real checked binding&#039;s init function
	        ko.bindingHandlers.checked.init(element, valueAccessor, allBindingsAccessor, context);
	    }      
	};

	ko.bindingHandlers.datepicker = {
	    init: function(element, valueAccessor, allBindingsAccessor) {
	        var $el = jQuery(element);
	        
	        //initialize datepicker with some optional options
	        var options = allBindingsAccessor().datepickerOptions || {};
	        $el.datepicker(options);
	        jQuery.datepicker.setDefaults(jQuery.datepicker.regional.fr);

	        //handle the field changing
	        ko.utils.registerEventHandler(element, &quot;change&quot;, function() {
	            var observable = valueAccessor();
	            observable($el.datepicker(&quot;getDate&quot;));
	            jQuery(element).blur();
	        });

	        //handle disposal (if KO removes by the template binding)
	        ko.utils.domNodeDisposal.addDisposeCallback(element, function() {
	            $el.datepicker(&quot;destroy&quot;);
	        });

	    },
	    update: function(element, valueAccessor) {
	        var value = ko.utils.unwrapObservable(valueAccessor()),
	            $el = jQuery(element),
	            current = $el.datepicker(&quot;getDate&quot;);
	        
	        if (value - current !== 0) {
	            $el.datepicker(&quot;setDate&quot;, value);   
	        }
	    }
	};

	//verification qu&#039;une date est postérieure à une autre
	//extension ko-validation
	ko.validation.rules.dateAfter = {
	    validator: function (val, other) {
	        return moment(val).isAfter(moment(other)); // true
	    },
	    message: &#039;La date doit être postérieure à la date de début&#039;
	};

	// ko.validation.rules.fileType = {
	//     validator: function (val, type) {
	//         return val.type.indexOf(type)&gt;-1;
	//     },
	//     message: &#039;Le fichier n\&#039;est pas au bon format&#039;
	// }; 

	// ko.validation.rules.fileSize = {
	//     validator: function (val, size) {
	//         return parseInt(val.size)&lt;=parseInt(size);
	//     },
	//     message: &#039;La taille du fichier est trop importante (limite : 100 kb)&#039;
	// };

	ko.validation.registerExtenders();
	ko.validation.init({ 
		insertMessages : true,
		decorateElement : true,
		errorsAsTitle : false,
		parseInputAttributes : true,
	    errorMessageClass : &#039;form_hint&#039;,
	    errorElementClass : &#039;input_hint&#039;,
	    messagesOnModified:true, //verifier tout le temps, meme au chargement 
	    grouping : { deep: true, observable: true },
	    decorateElementOnModified : false,
	});

	var kidzouEventsEditor = function() { 

		var model = new EventsEditorModel();

		function Tab(id, name, action, options) {
		    this.id = id;
		    this.name = ko.observable(name);
		    this.action = ko.observable(action);
		    this.options = options;
		}

		function Place(_venue, _address, _website, _phone_number) {
			this.venue = ko.observable(_venue).extend({ required: { message: &#039;Il faut nous indiquer où ca se passe !&#039; }, notify: &#039;always&#039; });
			this.address = ko.observable(_address).extend({ required: { message: &#039;Et ca se trouve ou ?&#039; }, notify: &#039;always&#039; });
			this.website = ko.observable(_website).extend({ notify: &#039;always&#039;, pattern: &quot;(http|ftp|https)://[a-z0-9\-_]+(\.[a-z0-9\-_]+)+([a-z0-9\-\.,@\?^=%&amp;;:/~\+#]*[a-z0-9\-@\?^=%&amp;;/~\+#])?&quot; }); //http://stackoverflow.com/questions/8188645/javascript-regex-to-match-a-url-in-a-field-of-text
			this.phone_number = ko.observable(_phone_number).extend({ notify: &#039;always&#039;, pattern: &quot;^0[1-9]([-. ]?[0-9]{2}){4}$&quot; }); //http://fr.openclassrooms.com/forum/sujet/mettre-une-regex-de-numero-de-telephone-en-javascript-93444
		}

		function Media() {

			var self = this;

			self.imageFile = ko.observable(); //.extend({ required: { message: &#039;Une petite image !&#039; }, fileType : &#039;image&#039;, fileSize: &#039;102400&#039;, notify: &#039;always&#039; });
	        self.imageObjectURL = ko.observable();
	        self.imageBinary = ko.observable();

	        self.fileSize = ko.computed(function() {
	            var file = self.imageFile();	
	            return file ? file.size : 0;
	        }, self);

	        self.firstBytes = ko.computed(function() {
	            if (self.imageBinary()) {
	                var buf = new Uint8Array(self.imageBinary());
	                var bytes = [];
	                for (var i = 0; i &lt; Math.min(10, buf.length); ++i) {
	                    bytes.push(buf[i]);
	                }
	                return &#039;[&#039; + bytes.join(&#039;, &#039;) + &#039;]&#039;;
	            } else {
	                return &#039;&#039;;
	            }
	        }, self);

		}

		function EventModel() {

			var self = this;

			self.id 				= ko.observable(0); //pas d&#039;interaction UI
			self.title 				= ko.observable(&quot;&quot;).extend({ notify: &#039;always&#039;, required: { message: &#039;Le titre de l\&#039;événement ?&#039; } });
			self.place 				= ko.observable(new Place());
		    self.start_date 	 	= ko.observable(moment().startOf(&quot;day&quot;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;));
		    self.end_date 			= ko.observable(moment().endOf(&quot;day&quot;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;)); //controler que n&#039;est pas inférieure à eventStartDate 
		    							//voir le thread http://stackoverflow.com/questions/14582450/comparing-two-fields-with-knockout-validation
		    self.extra_info 		= ko.observable(&quot;&quot;).extend({ notify: &#039;always&#039;, required: { message: &#039;Une petite description svp ?&#039; } }); 
		    self.image 				= ko.observable(&quot;&quot;);
		    self.status 	 		= ko.observable(&quot;draft&quot;);
		    //this.modified_by 		= 0; //automatiquement rempli dans l&#039;api
   		    

		    self.formattedStartDate 	= ko.computed({
		    	read: function() {
		    		return moment(self.start_date()).toDate();
		    	},
		    	write: function(value) {
		    		self.start_date(moment(value).startOf(&quot;day&quot;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;));
		    		self.start_date.notifySubscribers();
		    	},
		    	owner:self
			});
			self.formattedStartDate.extend({ required: true, notify: &#039;always&#039;}); 

		    self.formattedEndDate 	= ko.computed({
		    	read: function() {
		    		return moment(self.end_date()).toDate();
		    	},
		    	write: function(value) {
		    		self.end_date(moment(value).endOf(&#039;day&#039;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;));
		    		self.end_date.notifySubscribers();
		    	},
		    	owner:self
		    });
		    self.formattedEndDate.extend({ required: true, dateAfter : self.formattedStartDate, notify: &#039;always&#039; });

		    self.eventDuration = ko.computed(function() {
		    	// console.log(&quot;start_date dans eventDuration &quot; + self.start_date());
		    	// console.log(&quot;end_date dans eventDuration &quot; + self.end_date());
		    	var start = moment(self.start_date(), &quot;YYYY-MM-DD HH:mm:ss&quot;);
		    	var end = moment(self.end_date(), &quot;YYYY-MM-DD HH:mm:ss&quot;);
		    	var diff = end.diff(start, &#039;hours&#039;);
		    	if (moment.duration(diff, &quot;hours&quot;)&gt;0)
		    		return moment.duration(diff, &quot;hours&quot;).humanize();
		    	return &quot;&quot;;
		    });

		    this.dirtyFlag = new ko.dirtyFlag(this);

		    this.hasChanged = ko.computed(function() {
		    	return self.dirtyFlag.isDirty();
		    });

		    self.isValid = function() {
		    	// console.debug(&#039;self.formattedEndDate :&#039; + self.formattedEndDate.isValid());
		        return self.title.isValid() &amp;&amp;
			            self.extra_info.isValid() &amp;&amp;
			            self.formattedStartDate.isValid() &amp;&amp;
			            self.formattedEndDate.isValid() &amp;&amp;
			            self.place().venue.isValid() &amp;&amp;
			            self.place().address.isValid() &amp;&amp;
			            self.place().website.isValid() &amp;&amp;
			            self.place().phone_number.isValid(); 
		                      
		    };
		}


		function EventsEditorModel() {

			//todo :
			//- prévoir la gestion des evs qui durent 1j : checkbox pour le user ?
			//- indiquer qu&#039;une mise en avant est possible moyennant finance

		    var self = this;

		    self.message = new kidzouMessage.message();

		    self.formStep = ko.observable(0);

		    self.eventData 			= ko.observable(new EventModel());

		    //liste des evenements affichés à l&#039;ecran
		    //peut-être &quot;les brouillons&quot;, &quot;les demandes en cours&quot;, &quot;...&quot;
		    //initialement alimentée par la liste des events du user courant
		    self.eventsList = ko.observableArray();

		    //uniquement utilisé pour l&#039;autosave 
		    //ne pas utiliser le media pour calculer le dirtyflag
		    //car le media est sauvergadé par ailleurs
		    //sinon des requetes sont lancées en masse lors du telechargement du media !!
		    self.eventMedia 		= ko.observable(new Media()); //URL de l&#039;image associée

		    //si l&#039;utilisateur ne trouve pas son bonheur dans Google Places
		    //ce flag permet d&#039;afficher le formulaire d&#039;adresse custom
		    self.customPlace 		= ko.observable(false);

		    //lazy loading des tabs
		    //le contenu est chargé à la demande
		    self.tabs = ko.observableArray([
					        new Tab(1, &quot;Mes Brouillons&quot;, kidzou_jsvars.api_user_events, {status:&#039;draft&#039;}),
					        new Tab(2, &quot;En cours de publication&quot;, kidzou_jsvars.api_user_events, {status:&#039;requested&#039;}),
					        new Tab(3, &quot;Publiés&quot;, kidzou_jsvars.api_user_events, {status:&#039;approved&#039;})
					        ]);

			self.selectedTab = ko.observable(self.tabs()[0]);
			self.selectTab = function(tab) {

				self.addMessage(&#039;warning&#039;, &#039;rafraichissement des donn&amp;eacute;es...&#039;);
				
				self.selectedTab(tab);

				jQuery.getJSON(tab.action(), { status : tab.options.status }, function (data) {
					ko.mapping.fromJS(data.events, {} , self.eventsList);
					self.removeMessage();
				});
			};

		    self.userEvents = ko.observableArray();
		    
			// self.filtering = ko.observable(false);
			// self.filters = {year:-1, month:-1};
			// self.currentPage = ko.observable(0);
			// self.pages = ko.observable(0);
			// self.isMoreEvents = ko.computed(function(){
			// 	//plus d&#039;une page et on n&#039;est pas sur la dernière page
			// 	return self.pages()&gt;1 &amp;&amp; (self.currentPage()+1) &lt;=  self.pages();
			// });

			// function resetFilters() {
			// 	self.currentPage(0);
			// 	self.filters = {year:-1, month:-1};
			// }

			//gestion des tabs
			// self.currentTab = ko.observable(&#039;listEvents&#039;);
			// self.tabs = function( data, ev ) {
			// 	var label = jQuery(ev.target).data( &quot;label&quot; );
			// 	self.currentTab(router.next(label)); //prepare data for the view
			// };
		    
		    self.addMessage = function(_cls, _msg) {
		    	self.message.addMessage(_cls, _msg);
		    };

		    self.removeMessage = function() {
		    	self.message.removeMessage();
		    };

		    self.shortMessage = function(_cls, _msg) {
		    	self.message.addMessage(_cls, _msg);
		    	setTimeout(function(){
					self.message.removeMessage();
				},1500);
		    };


			self.editPlace = function() {
				self.formStep(1); //edit place
			};

			self.editDates = function() {
				self.formStep(2); //edit place
			};

			self.editDesc = function() {
				self.formStep(3); //edit place
			};

			self.completePlace = function(d,ev, result) {
				self.eventData().place(new Place(result.name, result.formatted_address, result.website, result.formatted_phone_number));
				self.customPlace(true); //make custom place from google place
				self.formStep(1); //Reafficher les details pour que le user les voient
			};

			self.displayCustomPlaceForm = function() {
				self.eventData().place(new Place()); //remise à zero si éventuellement existante
				self.customPlace(true);
			};

			self.displayGooglePlaceForm = function() {
				self.customPlace(false);
			};


			self.isFormComplete = ko.computed(function() {
				return self.eventData().isValid();
			});

			self.requestPublish = function() {

				vex.close();
				self.addMessage(&#039;warning&#039;, &#039;enregistrement en cours...&#039;);

				jQuery.post(kidzou_jsvars.api_request_publish, { 
	   				id : self.eventData().id()
   				}).done(function(db) {

   					if (db.status===&quot;ok&quot;) {
   						
   						jQuery(&quot;#event_&quot; + db.id).effect( &quot;fade&quot;, &quot;slow&quot; );

   						//supprimer l&#039;evenement de la liste
   						ko.utils.arrayFirst(self.eventsList(), function(item) {
   							if (item.id() === db.id) {
   								self.eventsList.remove(item);
   								// console.debug(&quot;evenement supprimé : &quot; + item.id());
				           		return true;
   							}
   							return false;
				        });

   						self.removeMessage();
				        //afficher un message de confirmation au user
				        jQuery(&quot;#tab_1&quot;).effect( &quot;highlight&quot; );
   						
   					} else {
   						self.shortMessage(&#039;error&#039;,&#039;Erreur lors de l&amp;apos;enregistrement: &#039; + db.error);
   					}
    			});

			};

			//utilisé pour le formattage des evenements dans la liste eventsList()
			self.eventDatesFormatter = function(ev) {
				var start_moment	= moment(ev.start_date(),&quot;YYYY-MM-DD HH:mm:ss&quot;);
				var end_moment		= moment(ev.end_date(), &quot;YYYY-MM-DD HH:mm:ss&quot;);
				var format_start = start_moment.format(&quot;DD/MM&quot;);
				var format_end 	= end_moment.format(&quot;DD/MM&quot;);
				if (format_start!== format_end)
					return &quot;Du &quot; + format_start + &quot; au &quot; + format_end;
				else
					return &quot;Le &quot; + format_start;
			};

			//la boite qui contient les details de l&#039;evenement issu de eventsList()
			self.openBox = function(el, index) {

				// console.log(&quot;index:&quot; + index);
				if (typeof index!==&quot;undefined&quot;)
				{
					var model = new EventModel();
					var selectedEvent = self.eventsList()[index];
					
					model.id (selectedEvent.id());//console.log(&quot;id &quot; + model.id);
					model.title(selectedEvent.title());
					model.place( new Place(selectedEvent.venue(), 
											selectedEvent.address(), 
											selectedEvent.website(), 
											selectedEvent.phone_number()) );
					model.start_date(selectedEvent.start_date());
					model.end_date(selectedEvent.end_date());
					model.extra_info(selectedEvent.extra_info());
					model.image(selectedEvent.image());
					model.status(selectedEvent.status());

					self.eventData(model);
					self.customPlace(true); //ne pas amorcer le form sur Google Place

					//affiche par défaut le lieu
					self.formStep(1);

				}
				else
				{
					self.eventData(new EventModel());
					self.customPlace(false); 
					self.eventMedia(new Media());
					self.formStep(1);
				} 


				vex.defaultOptions.className 			= &#039;vex-theme-top&#039;;
				vex.defaultOptions.overlayClosesOnClick = true;
				vex.dialog.buttons.YES.text 			= &#039;Fermer&#039;;

				vex.dialog.alert({
		            message: jQuery(&quot;.garage&quot;).detach().fadeIn(),
		            callback: function (data) {
		            	// console.log(data);
		            	//rattacher le html au garage
		            	jQuery(&quot;.garage&quot;).fadeOut().appendTo(&quot;body&quot;);

		            }
		        });

			};

	    	
	    	//déclenche une sauvegarde sur le serveur
	    	//de sorte que le user n&#039;a pas à se préoccuper de l&#039;enregistrement de ses données
		    self.autoSave = ko.computed(function() {

		    	if (self.eventData().hasChanged()) 
					self.saveEvent();

		    }, self);

		    self.saveEvent = function( ) {

		    	// console.log(&quot;saving event...&quot;);

		    	self.addMessage(&#039;warning&#039;,&#039;Enregistrement en cours...&#039;);

	    		//preparer les données pour l&#039;API
	    		var theEvent = ko.toJS(self.eventData());//console.log(theEvent);
	    		theEvent.venue = self.eventData().place().venue();
	    		theEvent.address = self.eventData().place().address();
	    		theEvent.website = self.eventData().place().website();
	    		theEvent.phone_number = self.eventData().place().phone_number();

	    		var newItem = (self.eventData().id()===0);

	    		//nettoyer l&#039;objet pour que seuls les attributs à sauvegarder en base 
	    		//soient transmis 
	    		delete theEvent.place;
	    		delete theEvent.formattedStartDate;
	    		delete theEvent.formattedEndDate;
	    		delete theEvent.eventDuration;
	    		delete theEvent.dirtyFlag;
	    		delete theEvent.media;
	    		delete theEvent.hasChanged;
	    		delete theEvent.isValid;

	    		jQuery.post(kidzou_jsvars.api_save_event, { 
	   				data : theEvent
   				}).done(function(db) {

   					if (db.status===&quot;ok&quot;) {
 
   						//mise à jour de l&#039;evenement en liste
   						var index = 0;
   						if (!newItem)  {
   							var eventUpdate = ko.utils.arrayFirst(self.eventsList(), function(item) {
	   							if (item.id() === db.data.id) {
	   								index = self.eventsList().indexOf(item);
					            	return true;
	   							}
	   							return false;
					        });

					        ko.mapping.fromJS(db.data, {}, self.eventsList()[index]);

   						} else {
   							//nouvel item créé dans la liste, inséré en tête de liste
   							if (typeof db.data.website===&quot;undefined&quot;)
   								db.data.website=&quot;&quot;;
   							if (typeof db.data.phone_number===&quot;undefined&quot;)
   								db.data.phone_number=&quot;&quot;;
   							
   							self.eventsList.unshift(ko.mapping.fromJS(db.data));
   							self.eventData().id(db.data.id);
   							// console.log(&quot;id créé : &quot; + db.data.id);
   						}

   						self.removeMessage();

   						jQuery(&quot;#event_&quot; + self.eventData().id()).effect( &quot;bounce&quot;, &quot;slow&quot; );
   						jQuery( &quot;#serverMessage&quot; ).html(&quot;modifications enregistr&amp;eacute;es&quot;).fadeIn().fadeOut(&quot;slow&quot;);

   					} else {
   						self.shortMessage(&#039;error&#039;,&#039;Erreur lors de l&amp;apos;enregistrement: &#039; + db.error);
   					}
    			});

		    };

		    self.setEvents = function (json) {
		    	self.eventsList = ko.mapping.fromJS(json.events);
		    };

			self.isDraft = ko.computed(function() {
		    	return self.eventData().status()===&#039;draft&#039;;
		    });

		    self.isPublished = ko.computed(function() {
		    	return self.eventData().status()===&#039;approved&#039;;
		    });

		    self.isRequested = ko.computed(function() {
		    	// console.debug(self.eventData().status());
		    	return self.eventData().status()===&#039;requested&#039;;
		    });


		    //disponible uniquement sur les brouillons et les requested
		    self.duplicateEvent = function () {
		    	// console.log(&quot;duplicateEvent&quot;);
		    	if (self.eventData().status()!==&#039;approved&#039; &amp;&amp; self.eventData().id()&gt;0) {//id existant 

			        //sauveegarde du nouvel objet
			        self.eventData().status(&quot;draft&quot;); //tout objet issu d&#039;une duplication est en draft
			        self.eventData().id(0); 

		    		vex.close();
			    }
		    };

		    //disponible uniquement sur les brouillons et demandes de pub
		    self.removeEvent = function () {

		    	vex.close();

		    	if (self.eventData().status()!==&quot;approved&quot;) {
		    		self.addMessage(&#039;warning&#039;, &#039;enregistrement en cours...&#039;);
			    	var id = self.eventData().id();
			    	var eventRemove = ko.utils.arrayFirst(self.eventsList(), function(item) {
			            return item.id() === id;
			        });

			        jQuery.post(kidzou_jsvars.api_remove_event, { 
		   				id : id
	   				}).done(function(db) {
	   					self.removeMessage();
	   					self.eventsList.remove(eventRemove);
				    	// console.log(&quot;supprimé&quot;);
				    	
	   				});
			        
			    }
		    };
			
		}

		return { 
			model 		: model
		};

	}();  //kidzouEventsEditor

	head.ready(function() {
		// console.log(kidzouEventsEditor.model);
		ko.applyBindings( kidzouEventsEditor.model );

	});

	return {
		model : kidzouEventsEditor.model //necessaire de fournir un acces au dialog pour interaction avec Google Maps
	};

}());  //kidzouEventsModule

Array.prototype.remove = function() {
    var what, a = arguments, L = a.length, ax;
    while (L &amp;&amp; this.length) {
        what = a[--L];
        while ((ax = this.indexOf(what)) !== -1) {
            this.splice(ax, 1);
        }
    }
    return this;
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
