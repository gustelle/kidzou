var kidzouModule=function(){String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},String.prototype.stripSlashes=function(){return this.replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return b}})},String.prototype.toBoolean=function(){switch(this.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(this)}};var a=function(){function a(a){d=a.toBoolean()}function b(a){d&&console.debug(a)}function c(a){d&&console.log(a)}var d=!1;return{setLogging:a,debug:b,info:c}}(),b=function(){function b(b){a.debug("setLocalSupport "+b),j=b}function c(b){if(!f()||!j)return null;var c=localStorage.getCacheItem(b);return a.debug("fromLocalData "+c),null===c?null:JSON.parse(c)}function d(b,c){f()&&j&&null!==c&&null!==b&&""!==b&&(a.debug("toLocalData "+b),localStorage.setCacheItem(b,ko.toJSON(ko.mapping.toJS(c)),{days:30}))}function e(b){if(a.debug("removeLocalData "+b),f())try{localStorage.setCacheItem(b,"",{days:0}),localStorage.getCacheItem(b),localStorage.removeItem(b)}catch(c){a.debug("removeLocalData planté : "+c)}else i(b)}function f(){return"undefined"!=typeof Storage?!0:(a.debug("localStorage not supported "),!1)}function g(a,b){f()?localStorage.setItem(a,b):k(a,b,{path:"/",expires:180})}function h(a){return f()?localStorage.getItem(a):k(a)}function i(b){a.debug("removeLocal "+b),f()?localStorage.removeItem(b):k(b,null,{path:"/",expires:-1})}var j=!1,k=function(b,c,d){if(a.debug("cookie["+b+"] = "+c+" ("+ko.toJSON(d)+") "),"undefined"==typeof c){for(var e,f,g=document.cookie.split(";"),h=0;h<g.length;h++)if(e=jQuery.trim(g[h].substr(0,g[h].indexOf("="))),f=g[h].substr(g[h].indexOf("=")+1),e===b)return unescape(f)}else{if(d=d||{},c?c=escape(c):(c="",d.expires=-365),d.expires){var i=new Date;i.setDate(i.getDate()+d.expires),c+="; expires="+i.toUTCString()}d.domain&&(c+="; domain="+d.domain),d.path&&(c+="; path="+d.path),document.cookie=b+"="+c}};return{setLocalSupport:b,setLocal:g,getLocal:h,removeLocal:i,toLocalData:d,fromLocalData:c,removeLocalData:e}}(),c=function(){function c(b){a.debug("selectEventById "+b),ko.utils.arrayFirst(x.events,function(a){return"undefined"!=typeof a&&null!==a&&a.id==b?(x.selectEvent(a),!0):void 0})}function e(b){a.debug("mapVotedToVotables "+ko.toJSON(b)),ko.utils.arrayForEach(b,function(a){ko.utils.arrayFirst(w.votableItems,function(b){b.id==a.id&&b.voted(!0)})})}function f(){jQuery.getJSON(kidzou_commons_jsvars.api_get_votes_status,{posts_in:ko.toJSON(w.votableIds)},function(a){g(a.status)})}function g(a){ko.utils.arrayMap(a,function(a){var b=ko.utils.arrayFirst(w.votableItems,function(b){return b.id==a.id?b:void 0});null!==b&&b.votes(a.votes)})}function h(){var c=JSON.parse(b.getLocal("voted")),d=j();null===c||0===c.length?(a.debug("localVotes null pour user_hash "+d),(null===d||"undefined"===d)&&(d=""),jQuery.getJSON(kidzou_commons_jsvars.api_get_votes_user,{user_hash:j()}).done(function(c){a.debug("storeLocalVotes "+ko.toJSON(c)),null!==c&&null!==c.user_hash&&"undefined"!==c.user_hash&&i(c.user_hash),null!==c&&null!==c.voted&&c.voted.length>0&&(b.toLocalData("voted",c.voted),e(c.voted))})):e(c)}function i(c){null!==c&&""!==c&&"undefined"!==c&&(null===j()||""===j()||"undefined"===j())&&(a.debug("setUserHash : "+c),b.setLocal("user_hash",c))}function j(){return"undefined"===b.getLocal("user_hash")&&(a.debug("user_hash undefined"),b.removeLocal("user_hash")),b.getLocal("user_hash")}function k(c){y=c.toBoolean(),b.setLocalSupport(y),b.removeLocalData("kidzou_voted_posts"),a.debug("syncData "+c),"undefined"!=typeof Worker&&y?(a.info("*** syncEvents Worker Started ***"),n(),kidzou_commons_jsvars.cfg_activate_syncvotes?m():l()):l()}function l(){a.info("*** refreshVotes votes (no worker) ***"),f(),h()}function m(){var c=new Worker(kidzou_commons_jsvars.js_syncVotes_url);c.addEventListener("message",function(c){switch(c.data.cmd){case"setVotesCount":a.debug("setVotesCount "+ko.toJSON(c.data.response.status)),g(c.data.response.status);break;case"storeLocalVotes":a.debug("storeLocalVotes "+ko.toJSON(c.data.response.voted)),null!==c.data.response.user_hash&&"undefined"!==c.data.response.user_hash&&i(c.data.response.user_hash),b.toLocalData("voted",c.data.response.voted),e(c.data.response.voted);break;case"mapLocalVotes":a.debug("localVotes existants utilisés : "+ko.toJSON(c.data.response)),e(c.data.response);break;case"debug":a.debug(c.data.message);break;default:a.debug(c.data)}},!1),c.postMessage({cmd:"refreshVotesCount",API_VOTES_STATUS_URL:kidzou_commons_jsvars.api_get_votes_status,votesData:{posts_in:ko.toJSON(w.votableIds)}}),c.postMessage({cmd:"syncVotes",API_USERVOTES_URL:kidzou_commons_jsvars.api_get_votes_user,votesData:{localVotes:b.getLocal("voted"),posts_in:ko.toJSON(w.votableIds),user_hash:j()}})}function n(){{var c=new Worker(kidzou_commons_jsvars.js_syncEvents_url);x.events}c.addEventListener("message",function(c){switch(c.data.cmd){case"removeLocalEvent":var d=parseInt(c.data.id),e=parseInt(c.data.event_timestamp),f=parseInt(c.data.connections_id),g=parseInt(c.data.connections_timestamp),h="event-"+d;e>0&&(h=h+"-"+e),f>0&&(h=h+"-"+f),g>0&&(h=h+"-"+g),b.removeLocalData(h);break;case"storeLocalEvents":for(var i=0;i<c.data.data.events.length;i++)b.toLocalData("event-"+c.data.data.events[i].id+"-"+c.data.data.events[i].event_timestamp+"-"+c.data.data.events[i].connections_id+"-"+c.data.data.events[i].connections_timestamp,c.data.data.events[i]);break;case"debug":a.debug(c.data.message);break;default:a.debug(c.data)}},!1);var d=[];ko.utils.arrayForEach(jQuery(".selectableEvent"),function(a){var b=parseInt(jQuery(a).data("event")),c=parseInt(jQuery(a).data("timestamp")),e=parseInt(jQuery(a).data("connections")),f=parseInt(jQuery(a).data("connectionstimestamp"));d.push({id:b,event_timestamp:c,connections_id:e,connections_timestamp:f})}),a.debug("page_events "+ko.toJSON(d));for(var e=[],f=0;f<localStorage.length;f++){var g=localStorage.key(f),h=g.split("-");if("event"===h[0])if(h.length<4)b.removeLocalData(g);else{var i=JSON.parse(localStorage.getItem(g)).id,j=JSON.parse(localStorage.getItem(g)).event_timestamp||0,k=JSON.parse(localStorage.getItem(g)).connections_id||0,l=JSON.parse(localStorage.getItem(g)).connections_timestamp||0;e.push({id:parseInt(i),event_timestamp:parseInt(j),connections_id:parseInt(k),connections_timestamp:parseInt(l)})}}c.postMessage({cmd:"syncEvents",API_EVENTS_FETCH_URL:kidzou_commons_jsvars.api_get_event,eventsData:{page_events:ko.toJSON(d),local_events:ko.toJSON(e)}})}function o(){var a=this;a.votableIds=[],a.votableItems=[],a.getVotableItem=function(b){return ko.utils.arrayFirst(a.votableItems,function(a){return a.id==b?a:void 0})}}function p(c,d,e){var f=this;f.id=c,f.votes=ko.observable(d),f.voted=ko.observable(e),f.downActivated=ko.observable(!1),f.countText=ko.computed(function(){return f.downActivated()?kidzou_commons_jsvars.votable_countText_down:kidzou_commons_jsvars.votable_countText}),f.iconClass=ko.computed(function(){return f.voted()?"icon-alreadyvoted":"icon-heart"}),f.activateDown=function(){f.voted()&&f.downActivated(!0)},f.doUpOrDown=function(){f.voted()?f.doWithdraw():f.doVote()},f.deactivateDown=function(){f.downActivated(!1)},f.doVote=function(){if(a.debug("doVote"),!this.voted()){var c=this.id,d=parseInt(this.votes())+1;this.voted(!0),this.votes(d),a.info("doVote "+c+"(+1)"),jQuery.getJSON(kidzou_commons_jsvars.api_get_nonce,{controller:"vote",method:"up"}).done(function(d){if(a.debug("doVote "+ko.toJSON(d)),null!==d){var e=d.nonce;jQuery.getJSON(kidzou_commons_jsvars.api_vote_up,{post_id:c,nonce:e,user_hash:j()},function(c){null!==c.user_hash&&"undefined"!==c.user_hash&&i(c.user_hash),b.removeLocalData("voted"),a.debug("doVote executed")})}})}},f.doWithdraw=function(){if(this.voted()){var c=this.id,d=parseInt(this.votes())-1;this.voted(!1),this.votes(d),a.info("doWithdraw "+c+"(-1)"),jQuery.getJSON(kidzou_commons_jsvars.api_get_nonce,{controller:"vote",method:"down"}).done(function(d){var e=d.nonce;jQuery.getJSON(kidzou_commons_jsvars.api_vote_down,{post_id:c,nonce:e,user_hash:j()},function(c){null!==c.user_hash&&"undefined"!==c.user_hash&&i(c.user_hash),b.removeLocalData("voted"),a.debug("doWithdraw executed")})})}}}function q(){var c=this;c.events=[],c.selectedEvent=ko.observable(new s),c.scriptsLoaded=!1,c.selectEvent=function(c){a.info("selectEvent "+c.id);var e=(new Date).getMilliseconds();v.addMessage("info",kidzou_commons_jsvars.msg_loading),this.selectedEvent(c);var f=b.fromLocalData(c.storageKey());if(null!==f&&parseInt(f.event_timestamp)===parseInt(c.event_timestamp())&&parseInt(f.connections_id)===parseInt(c.connections_id)&&parseInt(f.connections_timestamp)===parseInt(c.connections_timestamp())){r(c,f,function(){d.showFancybox(jQuery("#event-details").html(),function(){d.resetEventsTabs()})});var g=(new Date).getMilliseconds();kidzouTracker.trackEvent("Fiche Agenda",location.pathname,c.title(),g-e)}else jQuery.getJSON(kidzou_commons_jsvars.api_get_event,{event_id:c.id}).done(function(a){r(c,a.event[0],function(){d.showFancybox(jQuery("#event-details").html(),function(){d.resetEventsTabs()})});var f=(new Date).getMilliseconds();kidzouTracker.trackEvent("Fiche Agenda",location.pathname,c.title(),f-e),b.toLocalData(c.storageKey(),c)})}}function r(a,b,c){if(null!==b){var d=b.extra_info||b.content||"",e="undefined"!=typeof b.link&&"string"!=typeof b.link?b.link.link:b.link,f="undefined"!=typeof b.link&&"string"!=typeof b.link?b.link.title:b.link_title,g="undefined"!=typeof b.connections_adresse&&"string"!=typeof b.connections_adresse?b.connections_adresse:b,h=b.dates_teaser||b.formattedDates||"",i=b.address||b.adresse||"",j=b.website||"",k=b.phone_number||"";a.title(null!==b.title?b.title.stripSlashes():""),a.content(null!==d?d.stripSlashes():""),null!==e&&""!==e&&(a.link(e),a.link_title("undefined"!=typeof f?f.stripSlashes():"")),a.post_title(null!==b.post_title?b.post_title.stripSlashes():""),a.post_name(b.post_name),a.formattedDates(h),a.image(b.image),a.website(j),a.phone_number(k),a.venue(null!==b.venue?b.venue.stripSlashes():""),a.adresse=null!==i?i.stripSlashes():"",a.extra_venue=null!==b.extra_venue?b.extra_venue.toBoolean():!1,a.event_timestamp(parseInt(b.event_timestamp)),a.connections_id=parseInt(b.connections_id),a.connections_timestamp(parseInt(b.connections_timestamp)),a.extra_venue===!1&&parseInt(b.connections_id)>0&&("undefined"!=typeof b.organization&&""!==b.organization&&a.venue(b.organization),a.latitude=g.latitude,a.longitude=g.longitude,(null===i||""===i)&&(a.adresse=(null!==g.line_1?g.line_1.stripSlashes():"")+" "+(null!==g.line_2?g.line_2.stripSlashes():"")+" "+(null!==g.line_3?g.line_3.stripSlashes():"")+" "+g.zipcode+" "+(null!==g.city?g.city.stripSlashes():""))),""===a.image()&&a.image(kidzou_commons_jsvars.cfg_connections_image_base+b.connections_options.logo.name),c()}}function s(){var a=this;a.id=0,a.selected=ko.observable(!1),a.content=ko.observable(""),a.link=ko.observable(""),a.link_title=ko.observable(""),a.title=ko.observable(""),a.image=ko.observable(""),a.event_timestamp=ko.observable(0),a.website=ko.observable(""),a.phone_number=ko.observable(""),a.connections_id=0,a.connections_timestamp=ko.observable(0),a.latitude=0,a.longitude=0,a.adresse="",a.cached=!1,a.venue=ko.observable(""),a.extra_venue=!1,a.start_date="",a.end_date="",a.formattedDates=ko.observable(""),a.post_name=ko.observable(""),a.post_title=ko.observable(""),a.post_href=ko.computed(function(){return kidzou_commons_jsvars.cfg_site_url+a.post_name()}),a.isPostAttached=ko.computed(function(){return""!==a.post_name()&&null!==a.post_name()}),a.storageKey=ko.computed(function(){return"event-"+a.id+"-"+a.event_timestamp()+"-"+a.connections_id+"-"+a.connections_timestamp()})}function t(){ko.applyBindings(u())}function u(){return{message:v,events:x,votes:w}}{var v=new kidzouMessage.message,w=new o,x=new q,y=!1;!function(){a.debug("initInteractions"),ko.utils.arrayMap(jQuery(".votable"),function(a){w.votableIds.push(jQuery(a).data("post")),w.votableItems.push(new p(jQuery(a).data("post"),0,!1))}),ko.utils.arrayMap(jQuery(".selectableEvent"),function(a){var b=new s;b.id=jQuery(a).data("event"),b.connections_id=parseInt(jQuery(a).data("connections")),b.event_timestamp(parseInt(jQuery(a).data("timestamp"))),b.connections_timestamp(parseInt(jQuery(a).data("connectionstimestamp"))),x.events[b.id]=b})}()}return{viewModel:u,syncData:k,selectEventById:c,bindView:t}}(),d=function(){function d(){"none"===jQuery("#mobile_nav").css("display")?(vex.defaultOptions.contentClassName="",vex.defaultOptions.className="vex-theme-top",vex.defaultOptions.overlayClosesOnClick=!0,vex.dialog.buttons.YES.text="Fermer",vex.dialog.alert({message:jQuery(".newspan").html(),callback:function(){b.setLocal("kz_newsletter","1")}})):b.setLocal("kz_newsletter","1")}function e(){a.debug("resetEventsTabs"),jQuery("[data-content]").removeClass("active"),jQuery('[data-content="info"]').addClass("active"),jQuery(".event-map").children().remove()}function f(a,b){e(),c.viewModel().message.removeMessage(),vex.defaultOptions.className="vex-theme-top",vex.defaultOptions.overlayClosesOnClick=!0,vex.dialog.buttons.YES.text="Fermer",vex.defaultOptions.contentClassName="",vex.dialog.alert({message:a,callback:b()}),g()}function g(){a.debug("switchEventTab"),jQuery("[data-tab]").on("click",function(){a.debug("[data-tab]="+jQuery(this).data("tab")),jQuery("[data-content]").removeClass("active"),jQuery("[data-content="+jQuery(this).data("tab")+"]").addClass("active"),"map"===jQuery(this).data("tab")&&(c.viewModel().events.scriptsLoaded?(a.debug("Fiche Agenda - Carte =>  locale"),kidzouTracker.trackEvent("Fiche Agenda - Carte","Locale","Click",0),h()):(a.debug("Fiche Agenda - Carte => Serveur"),kidzouTracker.trackEvent("Fiche Agenda - Carte","Serveur","Click",0),jQuery.getScript(kidzou_commons_jsvars.js_google_maps+"&callback=kidzouModule.dialogs.initializeMap")))})}function h(){function b(b){a.debug("createMarker "+b),b?jQuery.goMap.createMarker({latitude:parseFloat(c.viewModel().events.selectedEvent().latitude),longitude:parseFloat(c.viewModel().events.selectedEvent().longitude),html:{content:"<strong>"+c.viewModel().events.selectedEvent().venue()+"</strong><br/>"+c.viewModel().events.selectedEvent().adresse,popup:!0}}):jQuery.goMap.createMarker({address:c.viewModel().events.selectedEvent().adresse,html:{content:"<strong>"+c.viewModel().events.selectedEvent().venue()+"</strong><br/>"+c.viewModel().events.selectedEvent().adresse,popup:!0}})}jQuery(".event-map").html('<span class="warning">Chargement de la carte...</span>');var d={},e=null!==c.viewModel().events.selectedEvent().latitude&&0!==c.viewModel().events.selectedEvent().latitude&&null!==c.viewModel().events.selectedEvent().longitude&&0!==c.viewModel().events.selectedEvent().longitude;a.debug("isLatLng "+e),a.debug("adresse "+c.viewModel().events.selectedEvent().adresse),d=e?{latitude:parseFloat(c.viewModel().events.selectedEvent().latitude),longitude:parseFloat(c.viewModel().events.selectedEvent().longitude),scaleControl:!0,maptype:"ROADMAP",zoom:15}:{address:c.viewModel().events.selectedEvent().adresse,scaleControl:!0,maptype:"ROADMAP",zoom:15},c.viewModel().events.scriptsLoaded?(a.debug("goMap "+ko.toJSON(d)),jQuery(".event-map").goMap(d),b(e)):(a.debug("initializeMap() => getScript"),jQuery.getScript(kidzou_commons_jsvars.js_gomap_url,function(){jQuery(".event-map").goMap(d),c.viewModel().events.scriptsLoaded=!0,b(e)}))}return{openShareDialog:d,resetEventsTabs:e,showFancybox:f,initializeMap:h}}();return jQuery(".share").click(function(){d.openShareDialog()}),jQuery(".selectableEvent").on("click",function(){var a=jQuery(this).data("event");c.selectEventById(a)}),head.ready(function(){a.setLogging(kidzou_commons_jsvars.cfg_debug_mode),c.syncData(kidzou_commons_jsvars.cfg_activate_datasync),c.bindView()}),{dialogs:d}}();