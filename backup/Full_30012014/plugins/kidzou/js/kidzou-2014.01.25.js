var kidzouModule=function(){String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},String.prototype.stripSlashes=function(){return this.replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return b}})},String.prototype.toBoolean=function(){switch(this.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(this)}};var a=function(){function a(a){d=a.toBoolean()}function b(a){d&&console.debug(a)}function c(a){d&&console.log(a)}var d=!1;return{setLogging:a,debug:b,info:c}}(),b=function(){function b(b){a.debug("selectEventById "+b),ko.utils.arrayFirst(w.events,function(a){return"undefined"!=typeof a&&null!==a&&a.id==b?(w.selectEvent(a),!0):void 0})}function d(b){a.debug("mapVotedToVotables "+ko.toJSON(b)),ko.utils.arrayForEach(b,function(a){ko.utils.arrayFirst(v.votableItems,function(b){b.id==a.id&&b.voted(!0)})})}function e(){jQuery.getJSON(kidzou_commons_jsvars.api_get_votes_status,{posts_in:ko.toJSON(v.votableIds)},function(a){f(a.status)})}function f(a){ko.utils.arrayMap(a,function(a){var b=ko.utils.arrayFirst(v.votableItems,function(b){return b.id==a.id?b:void 0});null!==b&&b.votes(a.votes)})}function g(){var b=JSON.parse(storageSupport.getLocal("voted")),c=i();null===b||0===b.length?(a.debug("localVotes null pour user_hash "+c),(null===c||"undefined"===c)&&(c=""),jQuery.getJSON(kidzou_commons_jsvars.api_get_votes_user,{user_hash:i()}).done(function(b){a.debug("storeLocalVotes "+ko.toJSON(b)),null!==b&&null!==b.user_hash&&"undefined"!==b.user_hash&&h(b.user_hash),null!==b&&null!==b.voted&&b.voted.length>0&&(storageSupport.toLocalData("voted",b.voted),d(b.voted))})):d(b)}function h(b){null!==b&&""!==b&&"undefined"!==b&&(null===i()||""===i()||"undefined"===i())&&(a.debug("setUserHash : "+b),storageSupport.setLocal("user_hash",b))}function i(){return"undefined"===storageSupport.getLocal("user_hash")&&(a.debug("user_hash undefined"),storageSupport.removeLocal("user_hash")),storageSupport.getLocal("user_hash")}function j(b){x=b.toBoolean(),storageSupport.setLocalSupport(x),storageSupport.removeLocalData("kidzou_voted_posts"),a.debug("syncData "+b),"undefined"!=typeof Worker&&x?(a.info("*** syncEvents Worker Started ***"),m(),kidzou_commons_jsvars.cfg_activate_syncvotes?l():k()):k()}function k(){a.info("*** refreshVotes votes (no worker) ***"),e(),g()}function l(){var b=new Worker(kidzou_commons_jsvars.js_syncVotes_url);b.addEventListener("message",function(b){switch(b.data.cmd){case"setVotesCount":a.debug("setVotesCount "+ko.toJSON(b.data.response.status)),f(b.data.response.status);break;case"storeLocalVotes":a.debug("storeLocalVotes "+ko.toJSON(b.data.response.voted)),null!==b.data.response.user_hash&&"undefined"!==b.data.response.user_hash&&h(b.data.response.user_hash),storageSupport.toLocalData("voted",b.data.response.voted),d(b.data.response.voted);break;case"mapLocalVotes":a.debug("localVotes existants utilisÃ©s : "+ko.toJSON(b.data.response)),d(b.data.response);break;case"debug":a.debug(b.data.message);break;default:a.debug(b.data)}},!1),b.postMessage({cmd:"refreshVotesCount",API_VOTES_STATUS_URL:kidzou_commons_jsvars.api_get_votes_status,votesData:{posts_in:ko.toJSON(v.votableIds)}}),b.postMessage({cmd:"syncVotes",API_USERVOTES_URL:kidzou_commons_jsvars.api_get_votes_user,votesData:{localVotes:storageSupport.getLocal("voted"),posts_in:ko.toJSON(v.votableIds),user_hash:i()}})}function m(){{var b=new Worker(kidzou_commons_jsvars.js_syncEvents_url);w.events}b.addEventListener("message",function(b){switch(b.data.cmd){case"removeLocalEvent":var c=parseInt(b.data.id),d=parseInt(b.data.event_timestamp),e=parseInt(b.data.connections_id),f=parseInt(b.data.connections_timestamp),g="event-"+c;d>0&&(g=g+"-"+d),e>0&&(g=g+"-"+e),f>0&&(g=g+"-"+f),storageSupport.removeLocalData(g);break;case"storeLocalEvents":for(var h=0;h<b.data.data.events.length;h++)storageSupport.toLocalData("event-"+b.data.data.events[h].id+"-"+b.data.data.events[h].event_timestamp+"-"+b.data.data.events[h].connections_id+"-"+b.data.data.events[h].connections_timestamp,b.data.data.events[h]);break;case"debug":a.debug(b.data.message);break;default:a.debug(b.data)}},!1);var c=[];ko.utils.arrayForEach(jQuery(".selectableEvent"),function(a){var b=parseInt(jQuery(a).data("event")),d=parseInt(jQuery(a).data("timestamp")),e=parseInt(jQuery(a).data("connections")),f=parseInt(jQuery(a).data("connectionstimestamp"));c.push({id:b,event_timestamp:d,connections_id:e,connections_timestamp:f})}),a.debug("page_events "+ko.toJSON(c));for(var d=[],e=0;e<localStorage.length;e++){var f=localStorage.key(e),g=f.split("-");if("event"===g[0])if(g.length<4)storageSupport.removeLocalData(f);else{var h=JSON.parse(localStorage.getItem(f)).id,i=JSON.parse(localStorage.getItem(f)).event_timestamp||0,j=JSON.parse(localStorage.getItem(f)).connections_id||0,k=JSON.parse(localStorage.getItem(f)).connections_timestamp||0;d.push({id:parseInt(h),event_timestamp:parseInt(i),connections_id:parseInt(j),connections_timestamp:parseInt(k)})}}b.postMessage({cmd:"syncEvents",API_EVENTS_FETCH_URL:kidzou_commons_jsvars.api_get_event,eventsData:{page_events:ko.toJSON(c),local_events:ko.toJSON(d)}})}function n(){var a=this;a.votableIds=[],a.votableItems=[],a.getVotableItem=function(b){return ko.utils.arrayFirst(a.votableItems,function(a){return a.id==b?a:void 0})}}function o(b,c,d){var e=this;e.id=b,e.votes=ko.observable(c),e.voted=ko.observable(d),e.downActivated=ko.observable(!1),e.countText=ko.computed(function(){return e.downActivated()?kidzou_commons_jsvars.votable_countText_down:kidzou_commons_jsvars.votable_countText}),e.iconClass=ko.computed(function(){return e.voted()?"icon-alreadyvoted":"icon-heart"}),e.activateDown=function(){e.voted()&&e.downActivated(!0)},e.doUpOrDown=function(){e.voted()?e.doWithdraw():e.doVote()},e.deactivateDown=function(){e.downActivated(!1)},e.doVote=function(){if(a.debug("doVote"),!this.voted()){var b=this.id,c=parseInt(this.votes())+1;this.voted(!0),this.votes(c),a.info("doVote "+b+"(+1)"),jQuery.getJSON(kidzou_commons_jsvars.api_get_nonce,{controller:"vote",method:"up"}).done(function(c){if(a.debug("doVote "+ko.toJSON(c)),null!==c){var d=c.nonce;jQuery.getJSON(kidzou_commons_jsvars.api_vote_up,{post_id:b,nonce:d,user_hash:i()},function(b){null!==b.user_hash&&"undefined"!==b.user_hash&&h(b.user_hash),storageSupport.removeLocalData("voted"),a.debug("doVote executed")})}})}},e.doWithdraw=function(){if(this.voted()){var b=this.id,c=parseInt(this.votes())-1;this.voted(!1),this.votes(c),a.info("doWithdraw "+b+"(-1)"),jQuery.getJSON(kidzou_commons_jsvars.api_get_nonce,{controller:"vote",method:"down"}).done(function(c){var d=c.nonce;jQuery.getJSON(kidzou_commons_jsvars.api_vote_down,{post_id:b,nonce:d,user_hash:i()},function(b){null!==b.user_hash&&"undefined"!==b.user_hash&&h(b.user_hash),storageSupport.removeLocalData("voted"),a.debug("doWithdraw executed")})})}}}function p(){var b=this;b.events=[],b.selectedEvent=ko.observable(new r),b.scriptsLoaded=!1,b.selectEvent=function(b){a.info("selectEvent "+b.id);var d=(new Date).getMilliseconds();u.addMessage("info",kidzou_commons_jsvars.msg_loading),this.selectedEvent(b);var e=storageSupport.fromLocalData(b.storageKey());if(null!==e&&parseInt(e.event_timestamp)===parseInt(b.event_timestamp())&&parseInt(e.connections_id)===parseInt(b.connections_id)&&parseInt(e.connections_timestamp)===parseInt(b.connections_timestamp())){q(b,e,function(){c.showFancybox(jQuery("#event-details").html(),function(){c.resetEventsTabs()})});var f=(new Date).getMilliseconds();kidzouTracker.trackEvent("Fiche Agenda",location.pathname,b.title(),f-d)}else jQuery.getJSON(kidzou_commons_jsvars.api_get_event,{event_id:b.id}).done(function(a){q(b,a.event[0],function(){c.showFancybox(jQuery("#event-details").html(),function(){c.resetEventsTabs()})});var e=(new Date).getMilliseconds();kidzouTracker.trackEvent("Fiche Agenda",location.pathname,b.title(),e-d),storageSupport.toLocalData(b.storageKey(),b)})}}function q(a,b,c){if(null!==b){var d=b.extra_info||b.content||"",e="undefined"!=typeof b.link&&"string"!=typeof b.link?b.link.link:b.link,f="undefined"!=typeof b.link&&"string"!=typeof b.link?b.link.title:b.link_title,g="undefined"!=typeof b.connections_adresse&&"string"!=typeof b.connections_adresse?b.connections_adresse:b,h=b.dates_teaser||b.formattedDates||"",i=b.address||b.adresse||"",j=b.website||"",k=b.phone_number||"";a.title(null!==b.title?b.title.stripSlashes():""),a.content(null!==d?d.stripSlashes():""),null!==e&&""!==e&&(a.link(e),a.link_title("undefined"!=typeof f?f.stripSlashes():"")),a.post_title(null!==b.post_title?b.post_title.stripSlashes():""),a.post_name(b.post_name),a.formattedDates(h),a.image(b.image),a.website(j),a.phone_number(k),a.venue(null!==b.venue?b.venue.stripSlashes():""),a.adresse=null!==i?i.stripSlashes():"",a.extra_venue=null!==b.extra_venue&&"string"==typeof b.extra_venue?b.extra_venue.toBoolean():b.extra_venue,a.event_timestamp(parseInt(b.event_timestamp)),a.connections_id=parseInt(b.connections_id),a.connections_timestamp(parseInt(b.connections_timestamp)),a.extra_venue===!1&&parseInt(b.connections_id)>0&&("undefined"!=typeof b.organization&&""!==b.organization&&a.venue(b.organization),a.latitude=g.latitude,a.longitude=g.longitude,(null===i||""===i)&&(a.adresse=(null!==g.line_1?g.line_1.stripSlashes():"")+" "+(null!==g.line_2?g.line_2.stripSlashes():"")+" "+(null!==g.line_3?g.line_3.stripSlashes():"")+" "+g.zipcode+" "+(null!==g.city?g.city.stripSlashes():""))),""===a.image()&&a.image(kidzou_commons_jsvars.cfg_connections_image_base+b.connections_options.logo.name),c()}}function r(){var a=this;a.id=0,a.selected=ko.observable(!1),a.content=ko.observable(""),a.link=ko.observable(""),a.link_title=ko.observable(""),a.title=ko.observable(""),a.image=ko.observable(""),a.event_timestamp=ko.observable(0),a.website=ko.observable(""),a.phone_number=ko.observable(""),a.connections_id=0,a.connections_timestamp=ko.observable(0),a.latitude=0,a.longitude=0,a.adresse="",a.cached=!1,a.venue=ko.observable(""),a.extra_venue=!1,a.start_date="",a.end_date="",a.formattedDates=ko.observable(""),a.post_name=ko.observable(""),a.post_title=ko.observable(""),a.post_href=ko.computed(function(){return kidzou_commons_jsvars.cfg_site_url+a.post_name()}),a.isPostAttached=ko.computed(function(){return""!==a.post_name()&&null!==a.post_name()}),a.storageKey=ko.computed(function(){return"event-"+a.id+"-"+a.event_timestamp()+"-"+a.connections_id+"-"+a.connections_timestamp()})}function s(){ko.applyBindings(t())}function t(){return{message:u,events:w,votes:v}}{var u=new kidzouMessage.message,v=new n,w=new p,x=!1;!function(){a.debug("initInteractions"),ko.utils.arrayMap(jQuery(".votable"),function(a){v.votableIds.push(jQuery(a).data("post")),v.votableItems.push(new o(jQuery(a).data("post"),0,!1))}),ko.utils.arrayMap(jQuery(".selectableEvent"),function(a){var b=new r;b.id=jQuery(a).data("event"),b.connections_id=parseInt(jQuery(a).data("connections")),b.event_timestamp(parseInt(jQuery(a).data("timestamp"))),b.connections_timestamp(parseInt(jQuery(a).data("connectionstimestamp"))),w.events[b.id]=b})}()}return{viewModel:t,syncData:j,selectEventById:b,bindView:s}}(),c=function(){function c(){"none"===jQuery("#mobile_nav").css("display")?(vex.defaultOptions.contentClassName="",vex.defaultOptions.className="vex-theme-top",vex.defaultOptions.overlayClosesOnClick=!0,vex.dialog.buttons.YES.text="Fermer",vex.dialog.alert({message:jQuery(".newspan").html(),callback:function(){storageSupport.setLocal("kz_newsletter","1")}})):storageSupport.setLocal("kz_newsletter","1")}function d(){a.debug("resetEventsTabs"),jQuery("[data-content]").removeClass("active"),jQuery('[data-content="info"]').addClass("active"),jQuery(".event-map").children().remove()}function e(a,c){d(),b.viewModel().message.removeMessage(),vex.defaultOptions.className="vex-theme-top",vex.defaultOptions.overlayClosesOnClick=!0,vex.dialog.buttons.YES.text="Fermer",vex.defaultOptions.contentClassName="",vex.dialog.alert({message:a,callback:c()}),f()}function f(){a.debug("switchEventTab"),jQuery("[data-tab]").on("click",function(){a.debug("[data-tab]="+jQuery(this).data("tab")),jQuery("[data-content]").removeClass("active"),jQuery("[data-content="+jQuery(this).data("tab")+"]").addClass("active"),"map"===jQuery(this).data("tab")&&(b.viewModel().events.scriptsLoaded?(a.debug("Fiche Agenda - Carte =>  locale"),kidzouTracker.trackEvent("Fiche Agenda - Carte","Locale","Click",0),g()):(a.debug("Fiche Agenda - Carte => Serveur"),kidzouTracker.trackEvent("Fiche Agenda - Carte","Serveur","Click",0),jQuery.getScript(kidzou_commons_jsvars.js_google_maps+"&callback=kidzouModule.dialogs.initializeMap")))})}function g(){function c(c){a.debug("createMarker "+c),c?jQuery.goMap.createMarker({latitude:parseFloat(b.viewModel().events.selectedEvent().latitude),longitude:parseFloat(b.viewModel().events.selectedEvent().longitude),html:{content:"<strong>"+b.viewModel().events.selectedEvent().venue()+"</strong><br/>"+b.viewModel().events.selectedEvent().adresse,popup:!0}}):jQuery.goMap.createMarker({address:b.viewModel().events.selectedEvent().adresse,html:{content:"<strong>"+b.viewModel().events.selectedEvent().venue()+"</strong><br/>"+b.viewModel().events.selectedEvent().adresse,popup:!0}})}jQuery(".event-map").html('<span class="warning">Chargement de la carte...</span>');var d={},e=null!==b.viewModel().events.selectedEvent().latitude&&0!==b.viewModel().events.selectedEvent().latitude&&null!==b.viewModel().events.selectedEvent().longitude&&0!==b.viewModel().events.selectedEvent().longitude;a.debug("isLatLng "+e),a.debug("adresse "+b.viewModel().events.selectedEvent().adresse),d=e?{latitude:parseFloat(b.viewModel().events.selectedEvent().latitude),longitude:parseFloat(b.viewModel().events.selectedEvent().longitude),scaleControl:!0,maptype:"ROADMAP",zoom:15}:{address:b.viewModel().events.selectedEvent().adresse,scaleControl:!0,maptype:"ROADMAP",zoom:15},b.viewModel().events.scriptsLoaded?(a.debug("goMap "+ko.toJSON(d)),jQuery(".event-map").goMap(d),c(e)):(a.debug("initializeMap() => getScript"),jQuery.getScript(kidzou_commons_jsvars.js_gomap_url,function(){jQuery(".event-map").goMap(d),b.viewModel().events.scriptsLoaded=!0,c(e)}))}return{openShareDialog:c,resetEventsTabs:d,showFancybox:e,initializeMap:g}}();return jQuery(".share").click(function(){c.openShareDialog()}),jQuery(".selectableEvent").on("click",function(){var a=jQuery(this).data("event");b.selectEventById(a)}),head.ready(function(){a.setLogging(kidzou_commons_jsvars.cfg_debug_mode),b.syncData(kidzou_commons_jsvars.cfg_activate_datasync),b.bindView()}),{dialogs:c}}();