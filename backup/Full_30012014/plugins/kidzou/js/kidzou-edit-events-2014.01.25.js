var kidzouEventsModule=function(){var a=window.URL||window.webkitURL;ko.dirtyFlag=function(a,b){var c=function(){},d=ko.observable(ko.toJSON(a)),e=ko.observable(b);return c.isDirty=ko.computed(function(){return e()||d()!==ko.toJSON(a)}),c.reset=function(){d(ko.toJSON(a)),e(!1)},c},ko.extenders.debug=function(a,b){return a.subscribe(function(a){console.debug(b+": "+a)}),a},ko.bindingHandlers.file={init:function(a,b){jQuery(a).change(function(){var a=this.files[0];ko.isObservable(b())&&b()(a)})},update:function(b,c,d){var e=ko.utils.unwrapObservable(c()),f=d();if(f.fileObjectURL&&ko.isObservable(f.fileObjectURL)){var g=f.fileObjectURL();g&&a.revokeObjectURL(g),f.fileObjectURL(e&&a.createObjectURL(e))}if(f.fileBinaryData&&ko.isObservable(f.fileBinaryData))if(e){var h=new FileReader;h.onload=function(a){f.fileBinaryData(a.target.result)},h.readAsArrayBuffer(e)}else f.fileBinaryData(null);if(e){jQuery("#serverMessage").html("&nbsp;T&eacute;l&eacute;chargement de la photo en cours...").fadeIn(),jQuery(b).next("span").remove();var i=b.files[0],j=!1,k="";if(-1===i.type.indexOf("image")?(j=!0,k="Le fichier doit &ecirc;tre une image"):parseInt(i.size)>102400&&(j=!0,k="Le taille du fichier ne doit pas exceder 100 kb"),j)jQuery(b).after("<span class='form_hint'>"+k+"</span>");else{var l=new FormData;l.append("file",i);var m=new XMLHttpRequest,n=null;m.open("POST",kidzou_jsvars.api_attach_image,!0),m.onreadystatechange=function(){4==this.readyState&&200==this.status?(n=JSON.parse(this.responseText),f.target&&ko.isObservable(f.target)&&(f.target(n.file.url),jQuery("#serverMessage").html("OK !").fadeOut("slow"))):jQuery("#serverMessage").html("Erreur lors du t&eacute;l&eacute;chargement !").fadeOut("slow")},m.send(l)}}}},ko.bindingHandlers.placecomplete={init:function(a,b,c){var d=b(),e=c(),f=e.lookupKey;if(jQuery(a).placecomplete(d),f){var g=ko.utils.unwrapObservable(e.value);jQuery(a).placecomplete("data",ko.utils.arrayFirst(d.data.results,function(a){return a[f]===g}))}ko.utils.domNodeDisposal.addDisposeCallback(a,function(){jQuery(a).placecomplete("destroy")})},update:function(a){jQuery(a).trigger("change")}},ko.bindingHandlers.date={update:function(a,b,c){var d=b(),e=c().stringFormat,f=c().dateFormat,g=moment(d,f);jQuery(a).text(g.format(e))}},ko.bindingHandlers.initCheckBox={init:function(a,b,c,d){var e=b();"1"===e?jQuery(a).attr("checked","checked"):jQuery(a).removeAttr("checked"),ko.bindingHandlers.checked.init(a,b,c,d)}},ko.bindingHandlers.datepicker={init:function(a,b,c){var d=jQuery(a),e=c().datepickerOptions||{};d.datepicker(e),jQuery.datepicker.setDefaults(jQuery.datepicker.regional.fr),ko.utils.registerEventHandler(a,"change",function(){var c=b();c(d.datepicker("getDate")),jQuery(a).blur()}),ko.utils.domNodeDisposal.addDisposeCallback(a,function(){d.datepicker("destroy")})},update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=jQuery(a),e=d.datepicker("getDate");c-e!==0&&d.datepicker("setDate",c)}},ko.validation.rules.dateAfter={validator:function(a,b){return moment(a).isAfter(moment(b))},message:"La date doit être postérieure à la date de début"},ko.validation.registerExtenders(),ko.validation.init({insertMessages:!0,decorateElement:!0,errorsAsTitle:!1,parseInputAttributes:!0,errorMessageClass:"form_hint",errorElementClass:"input_hint",messagesOnModified:!0,grouping:{deep:!0,observable:!0},decorateElementOnModified:!1});var b=function(){function a(a,b,c,d){this.id=a,this.name=ko.observable(b),this.action=ko.observable(c),this.options=d}function b(a,b,c,d){this.venue=ko.observable(a).extend({required:{message:"Il faut nous indiquer où ca se passe !"},notify:"always"}),this.address=ko.observable(b).extend({required:{message:"Et ca se trouve ou ?"},notify:"always"}),this.website=ko.observable(c).extend({notify:"always",pattern:"(http|ftp|https)://[a-z0-9-_]+(.[a-z0-9-_]+)+([a-z0-9-.,@?^=%&;:/~+#]*[a-z0-9-@?^=%&;/~+#])?"}),this.phone_number=ko.observable(d).extend({notify:"always",pattern:"^0[1-9]([-. ]?[0-9]{2}){4}$"})}function c(){var a=this;a.imageFile=ko.observable(),a.imageObjectURL=ko.observable(),a.imageBinary=ko.observable(),a.fileSize=ko.computed(function(){var b=a.imageFile();return b?b.size:0},a),a.firstBytes=ko.computed(function(){if(a.imageBinary()){for(var b=new Uint8Array(a.imageBinary()),c=[],d=0;d<Math.min(10,b.length);++d)c.push(b[d]);return"["+c.join(", ")+"]"}return""},a)}function d(){var a=this;a.id=ko.observable(0),a.title=ko.observable("").extend({notify:"always",required:{message:"Le titre de l'événement ?"}}),a.place=ko.observable(new b),a.start_date=ko.observable(moment().startOf("day").format("YYYY-MM-DD HH:mm:ss")),a.end_date=ko.observable(moment().endOf("day").format("YYYY-MM-DD HH:mm:ss")),a.extra_info=ko.observable("").extend({notify:"always",required:{message:"Une petite description svp ?"}}),a.image=ko.observable(""),a.status=ko.observable("draft"),a.formattedStartDate=ko.computed({read:function(){return moment(a.start_date()).toDate()},write:function(b){a.start_date(moment(b).startOf("day").format("YYYY-MM-DD HH:mm:ss")),a.start_date.notifySubscribers()},owner:a}),a.formattedStartDate.extend({required:!0,notify:"always"}),a.formattedEndDate=ko.computed({read:function(){return moment(a.end_date()).toDate()},write:function(b){a.end_date(moment(b).endOf("day").format("YYYY-MM-DD HH:mm:ss")),a.end_date.notifySubscribers()},owner:a}),a.formattedEndDate.extend({required:!0,dateAfter:a.formattedStartDate,notify:"always"}),a.eventDuration=ko.computed(function(){var b=moment(a.start_date(),"YYYY-MM-DD HH:mm:ss"),c=moment(a.end_date(),"YYYY-MM-DD HH:mm:ss"),d=c.diff(b,"hours");return moment.duration(d,"hours")>0?moment.duration(d,"hours").humanize():""}),this.dirtyFlag=new ko.dirtyFlag(this),this.hasChanged=ko.computed(function(){return a.dirtyFlag.isDirty()}),a.isValid=function(){return a.title.isValid()&&a.extra_info.isValid()&&a.formattedStartDate.isValid()&&a.formattedEndDate.isValid()&&a.place().venue.isValid()&&a.place().address.isValid()&&a.place().website.isValid()&&a.place().phone_number.isValid()}}function e(){var e=this;e.message=new kidzouMessage.message,e.formStep=ko.observable(0),e.eventData=ko.observable(new d),e.eventsList=ko.observableArray(),e.eventMedia=ko.observable(new c),e.customPlace=ko.observable(!1),e.tabs=ko.observableArray([new a(1,"Mes Brouillons",kidzou_jsvars.api_user_events,{status:"draft"}),new a(2,"En cours de publication",kidzou_jsvars.api_user_events,{status:"requested"}),new a(3,"Publiés",kidzou_jsvars.api_user_events,{status:"approved"})]),e.selectedTab=ko.observable(e.tabs()[0]),e.selectTab=function(a){e.addMessage("warning","rafraichissement des donn&eacute;es..."),e.selectedTab(a),jQuery.getJSON(a.action(),{status:a.options.status},function(a){ko.mapping.fromJS(a.events,{},e.eventsList),e.removeMessage()})},e.userEvents=ko.observableArray(),e.addMessage=function(a,b){e.message.addMessage(a,b)},e.removeMessage=function(){e.message.removeMessage()},e.shortMessage=function(a,b){e.message.addMessage(a,b),setTimeout(function(){e.message.removeMessage()},1500)},e.editPlace=function(){e.formStep(1)},e.editDates=function(){e.formStep(2)},e.editDesc=function(){e.formStep(3)},e.completePlace=function(a,c,d){e.eventData().place(new b(d.name,d.formatted_address,d.website,d.formatted_phone_number)),e.customPlace(!0),e.formStep(1)},e.displayCustomPlaceForm=function(){e.eventData().place(new b),e.customPlace(!0)},e.displayGooglePlaceForm=function(){e.customPlace(!1)},e.isFormComplete=ko.computed(function(){return e.eventData().isValid()}),e.requestPublish=function(){vex.close(),e.addMessage("warning","enregistrement en cours..."),jQuery.post(kidzou_jsvars.api_request_publish,{id:e.eventData().id()}).done(function(a){"ok"===a.status?(jQuery("#event_"+a.id).effect("fade","slow"),ko.utils.arrayFirst(e.eventsList(),function(b){return b.id()===a.id?(e.eventsList.remove(b),!0):!1}),e.removeMessage(),jQuery("#tab_1").effect("highlight")):e.shortMessage("error","Erreur lors de l&apos;enregistrement: "+a.error)})},e.eventDatesFormatter=function(a){var b=moment(a.start_date(),"YYYY-MM-DD HH:mm:ss"),c=moment(a.end_date(),"YYYY-MM-DD HH:mm:ss"),d=b.format("DD/MM"),e=c.format("DD/MM");return d!==e?"Du "+d+" au "+e:"Le "+d},e.openBox=function(a,f){if("undefined"!=typeof f){var g=new d,h=e.eventsList()[f];g.id(h.id()),g.title(h.title()),g.place(new b(h.venue(),h.address(),h.website(),h.phone_number())),g.start_date(h.start_date()),g.end_date(h.end_date()),g.extra_info(h.extra_info()),g.image(h.image()),g.status(h.status()),e.eventData(g),e.customPlace(!0),e.formStep(1)}else e.eventData(new d),e.customPlace(!1),e.eventMedia(new c),e.formStep(1);vex.defaultOptions.className="vex-theme-top",vex.defaultOptions.overlayClosesOnClick=!0,vex.dialog.buttons.YES.text="Fermer",vex.dialog.alert({message:jQuery(".garage").detach().fadeIn(),callback:function(){jQuery(".garage").fadeOut().appendTo("body")}})},e.autoSave=ko.computed(function(){e.eventData().hasChanged()&&e.saveEvent()},e),e.saveEvent=function(){e.addMessage("warning","Enregistrement en cours...");var a=ko.toJS(e.eventData());a.venue=e.eventData().place().venue(),a.address=e.eventData().place().address(),a.website=e.eventData().place().website(),a.phone_number=e.eventData().place().phone_number();var b=0===e.eventData().id();delete a.place,delete a.formattedStartDate,delete a.formattedEndDate,delete a.eventDuration,delete a.dirtyFlag,delete a.media,delete a.hasChanged,delete a.isValid,jQuery.post(kidzou_jsvars.api_save_event,{data:a}).done(function(a){if("ok"===a.status){var c=0;if(b)"undefined"==typeof a.data.website&&(a.data.website=""),"undefined"==typeof a.data.phone_number&&(a.data.phone_number=""),e.eventsList.unshift(ko.mapping.fromJS(a.data)),e.eventData().id(a.data.id);else{{ko.utils.arrayFirst(e.eventsList(),function(b){return b.id()===a.data.id?(c=e.eventsList().indexOf(b),!0):!1})}ko.mapping.fromJS(a.data,{},e.eventsList()[c])}e.removeMessage(),jQuery("#event_"+e.eventData().id()).effect("bounce","slow"),jQuery("#serverMessage").html("modifications enregistr&eacute;es").fadeIn().fadeOut("slow")}else e.shortMessage("error","Erreur lors de l&apos;enregistrement: "+a.error)})},e.setEvents=function(a){e.eventsList=ko.mapping.fromJS(a.events)},e.isDraft=ko.computed(function(){return"draft"===e.eventData().status()}),e.isPublished=ko.computed(function(){return"approved"===e.eventData().status()}),e.isRequested=ko.computed(function(){return"requested"===e.eventData().status()}),e.duplicateEvent=function(){"approved"!==e.eventData().status()&&e.eventData().id()>0&&(e.eventData().status("draft"),e.eventData().id(0),vex.close())},e.removeEvent=function(){if(vex.close(),"approved"!==e.eventData().status()){e.addMessage("warning","enregistrement en cours...");var a=e.eventData().id(),b=ko.utils.arrayFirst(e.eventsList(),function(b){return b.id()===a});jQuery.post(kidzou_jsvars.api_remove_event,{id:a}).done(function(){e.removeMessage(),e.eventsList.remove(b)})}}}var f=new e;return{model:f}}();return head.ready(function(){ko.applyBindings(b.model)}),{model:b.model}}();Array.prototype.remove=function(){for(var a,b,c=arguments,d=c.length;d&&this.length;)for(a=c[--d];-1!==(b=this.indexOf(a));)this.splice(b,1);return this};